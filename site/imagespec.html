<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ImageSpec Pro</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">

    <style>
        :root {
            --bg-primary: #111827; --bg-card: #1f2937; --border-primary: #374151;
            --border-secondary: #4b5563; --text-primary: #d1d5db; --text-secondary: #9ca3af;
            --text-white: #ffffff; --font-main: 'Inter', sans-serif; --accent-blue: #3b82f6;
            --accent-blue-hover: #2563eb; --accent-green: #22c55e; --accent-red: #ef4444;
            --accent-red-hover: #dc2626; --accent-cyan: #22d3ee;
        }
        html { color-scheme: dark; }
        body {
            background-color: var(--bg-primary); color: var(--text-primary); font-family: var(--font-main);
            font-size: 12px;
            display: flex; height: 100vh; overflow: hidden;
        }
        aside {
            width: 33.33%; min-width: 420px; max-width: 450px; height: 100%; display: flex;
            flex-direction: column; padding: 6px; gap: 6px; overflow-y: auto;
        }
        main { flex-grow: 1; height: 100%; display: flex; flex-direction: column; padding: 6px; }
        ::-webkit-scrollbar { width: 8px; height: 8px;}
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--border-secondary); border-radius: 4px; border: 2px solid var(--bg-primary); }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .card {
            background-color: var(--bg-card); border: 1px solid var(--border-primary);
            border-radius: 6px; padding: 10px; flex-shrink: 0;
        }
        .card-grow { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; }
        h1 { font-size: 18px; font-weight: 600; color: var(--text-white); margin: 0; padding: 0;}
        h2 { font-size: 13px; font-weight: 600; color: var(--text-white); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        header p { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
        label { display: block; font-size: 10px; font-weight: 500; color: var(--text-secondary); margin-bottom: 3px; text-transform: uppercase; }
        .control-group { display: flex; gap: 10px; align-items: flex-end; }
        .control-group > div { flex: 1; }
        .form-input, .form-select {
            background-color: var(--border-primary); border: 1px solid var(--border-secondary);
            color: var(--text-primary); border-radius: 4px; padding: 4px 7px;
            font-size: 12px; width: 100%; box-sizing: border-box; transition: all 0.2s;
        }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); }
        input[type='number']::-webkit-outer-spin-button, input[type='number']::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 5px;
            padding: 4px 9px; border-radius: 4px; font-weight: 500; font-size: 12px;
            transition: all 0.2s; border: 1px solid transparent; cursor: pointer; width: 100%;
        }
        
        .media-wrapper { position: relative; width: 100%; height: 100%; overflow: hidden; border-radius: 6px;}
        #mediaContainer {
            width: 100%; height: 100%; position: absolute; top: 0; left: 0;
            background-color: black; overflow: auto; cursor: crosshair;
        }
        #video, #uploadedImage { transform-origin: top left; max-width: none; position: absolute; top: 0; left: 0; }
        #roiOverlay { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; }
        .roi-indicator {
            position: absolute; border: 1px solid white;
            box-shadow: 0 0 8px rgba(0,0,0,0.7); 
            background-color: rgba(255, 255, 255, 0.1); 
            cursor: move; pointer-events: auto;
        }
        .roi-indicator.circle { border-radius: 50%; }
        .roi-indicator.selected { border-width: 2px; box-shadow: 0 0 12px rgba(59, 130, 246, 0.8); }
        .roi-indicator.calibrator { border-style: dashed; }
        #message { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: var(--text-secondary); padding: 16px;}
        .hidden { display: none; }

        .table-container { max-height: 150px; overflow-y: auto; border: 1px solid var(--border-primary); border-radius: 6px; position: relative; font-size: 11px;}
        table { width: 100%; font-size: 11px; text-align: left; border-collapse: collapse; }
        thead { background-color: var(--bg-card); position: sticky; top: 0; z-index: 10; }
        th, td { padding: 5px; border-bottom: 1px solid var(--border-primary); }
        td { vertical-align: middle; }
        .color-swatch { width: 12px; height: 12px; border-radius: 3px; display: inline-block; vertical-align: middle; margin-right: 5px; border: 1px solid rgba(0,0,0,0.2); }
        
        .chart-container { position: relative; min-height: 150px; flex-grow: 1; margin-top: 8px; }
        .delete-btn { cursor: pointer; color: var(--text-secondary); transition: color 0.2s; } .delete-btn:hover { color: var(--accent-red); }
        .button-group { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; } 

        #pointMeasurementCard .result-box {
            padding: 5px; border-radius: 4px; flex-grow: 1;
            min-width: 60px; position: relative; text-align: center;
        }
        #pointMeasurementCard .font-bold { font-weight: 600; font-size: 10px; text-transform: uppercase; }
        #pointMeasurementCard .font-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
        #pointMeasurementCard .text-lg { font-size: 14px; }
        #pointMeasurementCard .bg-red { background-color: rgba(127, 29, 29, 0.5); } 
        #pointMeasurementCard .bg-green { background-color: rgba(21, 128, 61, 0.5); }
        #pointMeasurementCard .bg-blue { background-color: rgba(30, 64, 175, 0.5); }
        
        @media (max-width: 1024px) {
            body { flex-direction: column; height: auto; overflow-y: auto; font-size: 14px; }
            aside { width: 100%; max-width: none; height: auto; overflow-y: visible; padding: 8px; }
            main { width: 100%; height: 60vh; padding: 0 8px 8px 8px; }
            .control-group { flex-direction: column; align-items: stretch; gap: 12px;}
        }
    </style>
</head>
<body>
    <canvas id="canvas" class="hidden"></canvas>

    <aside>
        <header>
            <h1><i class="bi bi-bullseye" style="color: var(--accent-blue);"></i> ImageSpec Pro</h1>
            <p>Advanced Image Analysis Spectrophotometer</p>
        </header>

        <div class="card">
            <h2>1. Setup Source</h2>
            <div class="control-group" style="margin-bottom: 12px;">
                <div>
                    <label for="sourceMode">Input Source</label>
                    <select id="sourceMode" class="form-select">
                        <option value="camera">Live Camera</option>
                        <option value="upload">Uploaded Image</option>
                    </select>
                </div>
                 <div id="mediaControlContainer" style="flex: 1.5;">
                    <div id="cameraControl">
                        <label for="cameraSelect">Select Camera</label>
                        <select id="cameraSelect" class="form-select"><option value="">Waiting for permission...</option></select>
                    </div>
                    <div id="uploadControl" class="hidden">
                         <label for="imageUpload">Upload Image</label>
                         <input type="file" id="imageUpload" accept="image/*" class="form-input">
                    </div>
                </div>
            </div>
             <div class="control-group">
                <div>
                    <label>Zoom (Ctrl+Scroll)</label>
                    <input type="range" id="zoomSlider" min="1" max="10" value="1" step="0.1" class="form-input">
                </div>
                <div style="flex: 0 0 50px;">
                    <label>Value</label>
                    <div id="zoomValue" style="font-size: 12px; padding-top: 4px;">1.0x</div>
                </div>
             </div>
        </div>
        
        <div class="card">
            <h2>2. Analysis Mode</h2>
            <select id="analysisMode" class="form-select">
                <option value="point">Point Measurement</option>
                <option value="kinetics">Kinetics (Time Series)</option>
                <option value="scan">Spectral Scan</option>
            </select>
            <div id="kineticsControls" class="control-group hidden" style="margin-top: 10px;">
                <div><label>Interval (sec)</label><input type="number" id="kineticsInterval" class="form-input" value="30" min="1"></div>
                <div><label>Cycles</label><input type="number" id="kineticsCycles" class="form-input" value="10" min="1"></div>
            </div>
            <div id="scanControls" class="control-group hidden" style="margin-top: 10px;">
                <div><label>Start λ (nm)</label><input type="number" id="scanStart" class="form-input" value="400" min="380" max="780"></div>
                <div><label>End λ (nm)</label><input type="number" id="scanEnd" class="form-input" value="700" min="380" max="780"></div>
                <div><label>Step (nm)</label><input type="number" id="scanStep" class="form-input" value="5" min="1"></div>
            </div>
        </div>
        
        <div class="card">
             <h2>3. Define Regions of Interest (ROI)</h2>
             <div class="control-group">
                 <div style="flex: 2;"><label>ROI Name</label><input type="text" id="roiName" class="form-input" value="ROI-1"></div>
                 <div><label>Color</label><input type="color" id="roiColor" class="form-input" value="#3b82f6" style="padding: 2px;"></div>
                 <div style="flex: 0 0 70px;"><label>&nbsp;</label><button id="addRoiBtn" class="btn btn-secondary"><i class="bi bi-plus-circle"></i> Add</button></div>
             </div>
             <div class="control-group" style="margin-top: 10px;">
                <div><label>Shape</label><select id="roiShape" class="form-select"><option value="square">Square</option><option value="circle">Circle</option></select></div>
                <div><label>Size (px)</label><input type="number" id="roiSize" class="form-input" value="50" min="1"></div>
            </div>
            <div id="roiTableContainer" class="table-container" style="margin-top: 10px; max-height: 120px;">
                <table id="roiTable">
                    <thead><tr><th>Color</th><th>Name</th><th>Type</th><th>Size</th><th>Del</th></tr></thead>
                    <tbody id="roiTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="card">
             <h2>4. Run Analysis</h2>
             <div class="control-group">
                <button id="calibrateBtn" class="btn btn-primary" disabled><i class="bi bi-eyedropper"></i> Calibrate Blank</button>
                <button id="runAnalysisBtn" class="btn btn-secondary" style="margin-top: 0px;" disabled><i class="bi bi-play-fill"></i> Run Analysis</button>
             </div>
        </div>

        <div id="pointMeasurementCard" class="card">
            <h2>Point Measurement</h2>
            <div id="pointResults" style="display: flex; flex-wrap: wrap; gap: 6px;">
                <div class="result-box bg-red"><p class="font-bold">Abs (R)</p><p id="absR" class="text-lg font-mono">-</p></div>
                <div class="result-box bg-green"><p class="font-bold">Abs (G)</p><p id="absG" class="text-lg font-mono">-</p></div>
                <div class="result-box bg-blue"><p class="font-bold">Abs (B)</p><p id="absB" class="text-lg font-mono">-</p></div>
            </div>
            <div class="control-group" style="margin-top: 10px;">
                <div style="flex: 2;"><label>Add Wavelength (nm)</label><input type="number" id="wavelengthInput" placeholder="380-780" class="form-input"></div>
                <div style="flex: 0 0 70px;"><label>&nbsp;</label><button id="addWavelengthBtn" class="btn btn-secondary"><i class="bi bi-plus-lg"></i></button></div>
            </div>
        </div>

        <div class="card card-grow">
            <h2>Results & Data</h2>
            <div class="chart-container"><canvas id="resultsChart"></canvas></div>
            <div id="resultsLogContainer" class="table-container">
                 <table id="resultsTable">
                    <thead><tr><th>Sample</th><th>Value</th></tr></thead>
                    <tbody id="resultsTableBody"></tbody>
                </table>
            </div>
            <div class="button-group">
                 <button id="exportChartBtn" class="btn btn-secondary"><i class="bi bi-image"></i> Export Chart</button>
                 <button id="exportDataBtn" class="btn btn-secondary"><i class="bi bi-download"></i> Export Data</button>
            </div>
        </div>
    </aside>

    <main>
        <div class="card card-grow" style="padding: 8px; display:flex; flex-direction:column;">
            <div class="media-wrapper">
                <div id="mediaContainer">
                    <video id="video" class="hidden"></video>
                    <img id="uploadedImage" class="hidden">
                    <div id="message"><i id="messageIcon" class="bi bi-camera-video-off" style="font-size: 2.25rem;"></i><p id="messageText">Select a camera to begin.</p></div>
                </div>
                <div id="roiOverlay"></div>
            </div>
        </div>
    </main>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const elements = {
                video: document.getElementById('video'),
                canvas: document.getElementById('canvas'),
                cameraSelect: document.getElementById('cameraSelect'),
                calibrateBtn: document.getElementById('calibrateBtn'),
                runAnalysisBtn: document.getElementById('runAnalysisBtn'),
                roiOverlay: document.getElementById('roiOverlay'),
                roiNameInput: document.getElementById('roiName'),
                roiColorInput: document.getElementById('roiColor'),
                addRoiBtn: document.getElementById('addRoiBtn'),
                roiShapeSelect: document.getElementById('roiShape'),
                roiSizeInput: document.getElementById('roiSize'),
                roiTableBody: document.getElementById('roiTableBody'),
                sourceModeSelect: document.getElementById('sourceMode'),
                cameraControl: document.getElementById('cameraControl'),
                uploadControl: document.getElementById('uploadControl'),
                imageUpload: document.getElementById('imageUpload'),
                uploadedImage: document.getElementById('uploadedImage'),
                message: document.getElementById('message'),
                messageIcon: document.getElementById('messageIcon'),
                messageText: document.getElementById('messageText'),
                mediaContainer: document.getElementById('mediaContainer'),
                zoomSlider: document.getElementById('zoomSlider'),
                zoomValue: document.getElementById('zoomValue'),
                analysisModeSelect: document.getElementById('analysisMode'),
                kineticsControls: document.getElementById('kineticsControls'),
                kineticsIntervalInput: document.getElementById('kineticsInterval'),
                kineticsCyclesInput: document.getElementById('kineticsCycles'),
                scanControls: document.getElementById('scanControls'),
                scanStartInput: document.getElementById('scanStart'),
                scanEndInput: document.getElementById('scanEnd'),
                scanStepInput: document.getElementById('scanStep'),
                pointMeasurementCard: document.getElementById('pointMeasurementCard'),
                pointResultsDiv: document.getElementById('pointResults'),
                wavelengthInput: document.getElementById('wavelengthInput'),
                addWavelengthBtn: document.getElementById('addWavelengthBtn'),
                resultsChartCanvas: document.getElementById('resultsChart'),
                resultsTableBody: document.getElementById('resultsTableBody'),
                exportChartBtn: document.getElementById('exportChartBtn'),
                exportDataBtn: document.getElementById('exportDataBtn'),
            };
            elements.ctx = elements.canvas.getContext('2d', { willReadFrequently: true });

            let state = {
                mode: 'camera', mediaReady: false, currentStream: null,
                rois: [], nextRoiId: 1, selectedRoiId: null, draggingRoiId: null,
                dragStart: { x: 0, y: 0 }, blankRgb: null, isCalibrated: false,
                analysisData: {}, zoom: 1, kineticsTimer: null, isAnalyzing: false,
                pointWavelengths: []
            };
            let chart;

            function wavelengthToRgb(wavelength) {
                let r, g, b; const gamma = 0.80;
                if (wavelength >= 380 && wavelength <= 439) { r = -(wavelength - 440) / (440 - 380); g = 0.0; b = 1.0; } 
                else if (wavelength >= 440 && wavelength <= 489) { r = 0.0; g = (wavelength - 440) / (490 - 440); b = 1.0; } 
                else if (wavelength >= 490 && wavelength <= 509) { r = 0.0; g = 1.0; b = -(wavelength - 510) / (510 - 490); } 
                else if (wavelength >= 510 && wavelength <= 579) { r = (wavelength - 510) / (580 - 510); g = 1.0; b = 0.0; } 
                else if (wavelength >= 580 && wavelength <= 644) { r = 1.0; g = -(wavelength - 645) / (645 - 580); b = 0.0; } 
                else if (wavelength >= 645 && wavelength <= 780) { r = 1.0; g = 0.0; b = 0.0; } 
                else { r = 0.0; g = 0.0; b = 0.0; }
                let factor;
                if (wavelength >= 380 && wavelength <= 419) factor = 0.3 + 0.7 * (wavelength - 380) / (420 - 380);
                else if (wavelength >= 420 && wavelength <= 780) factor = 1.0;
                else factor = 0.0;
                const pow = (x, p) => x < 0 ? 0 : Math.pow(x, p);
                return { r: Math.round(255 * pow(r * factor, gamma)), g: Math.round(255 * pow(g * factor, gamma)), b: Math.round(255 * pow(b * factor, gamma)) };
            }

            async function getCameras() {
                try {
                    await navigator.mediaDevices.getUserMedia({ video: true }); // Crucial for getting labels
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    elements.cameraSelect.innerHTML = '<option value="">Select a camera...</option>';
                    if (videoDevices.length === 0) {
                       elements.cameraSelect.innerHTML = '<option value="">No cameras found</option>';
                       if(state.mode === 'camera') setMode('upload');
                    } else {
                        videoDevices.forEach((device, index) => {
                            const option = document.createElement('option');
                            option.value = device.deviceId;
                            option.text = device.label || `Camera ${index + 1}`;
                            elements.cameraSelect.appendChild(option);
                        });
                    }
                } catch (error) { 
                    elements.cameraSelect.innerHTML = '<option value="">Permission denied</option>';
                    setMode('upload');
                }
            }

            async function startCamera(deviceId) {
                if (state.mode !== 'camera' || !deviceId) return;
                stopMedia();
                const constraints = { video: { deviceId: { exact: deviceId }, width: { ideal: 1280 }, height: { ideal: 720 } } };
                try {
                    state.currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                    elements.video.srcObject = state.currentStream;
                    await elements.video.play();
                    elements.video.classList.remove('hidden');
                    elements.message.classList.add('hidden');
                    elements.video.addEventListener('loadedmetadata', () => { 
                        state.mediaReady = true;
                        updateAllRoisPosition();
                        updateUI();
                    }, { once: true });
                } catch (error) { 
                    showMessage('bi-exclamation-triangle-fill', `Failed to start camera.`); 
                    state.mediaReady = false; updateUI();
                }
            }
            
            function stopMedia() {
                state.mediaReady = false;
                if (state.currentStream) { state.currentStream.getTracks().forEach(track => track.stop()); state.currentStream = null; }
            }

            function resetZoomAndScroll() {
                state.zoom = 1;
                const media = getActiveMediaElement();
                media.style.transform = `scale(1)`;
                elements.mediaContainer.scrollTop = 0;
                elements.mediaContainer.scrollLeft = 0;
                elements.zoomSlider.value = 1;
                elements.zoomValue.textContent = '1.0x';
            }

            function setMode(newMode) {
                state.mode = newMode;
                stopMedia();
                resetZoomAndScroll();
                elements.video.classList.add('hidden');
                elements.uploadedImage.classList.add('hidden');
                elements.cameraControl.classList.toggle('hidden', newMode !== 'camera');
                elements.uploadControl.classList.toggle('hidden', newMode === 'camera');
                if (newMode === 'camera') {
                    if (elements.cameraSelect.value && elements.cameraSelect.value !== "Permission denied" && elements.cameraSelect.value !== "No cameras found") {
                        startCamera(elements.cameraSelect.value);
                    } else {
                        showMessage('bi-camera-video-off', 'Select a camera to begin.');
                    }
                } else {
                    if (elements.uploadedImage.src) { 
                        elements.uploadedImage.classList.remove('hidden'); 
                        elements.message.classList.add('hidden');
                        state.mediaReady = true;
                    }
                    else { showMessage('bi-upload', 'Upload an image to begin analysis.'); }
                }
                updateAllRoisPosition();
                updateUI();
            }

            function handleImageUpload(e) {
                const file = e.target.files[0];
                if (!file) return;
                stopMedia();
                resetZoomAndScroll();
                const reader = new FileReader();
                reader.onload = (event) => {
                    elements.uploadedImage.src = event.target.result;
                    elements.uploadedImage.onload = () => {
                        elements.uploadedImage.classList.remove('hidden');
                        elements.message.classList.add('hidden');
                        state.mediaReady = true;
                        updateAllRoisPosition();
                        updateUI();
                    };
                };
                reader.readAsDataURL(file);
            }
            
            function getActiveMediaElement(){ return state.mode === 'camera' ? elements.video : elements.uploadedImage; }
            function showMessage(iconClass, text) { elements.message.classList.remove('hidden'); elements.messageIcon.className = `bi ${iconClass}`; elements.messageText.textContent = text; }
            
            function addRoi() {
                if (!state.mediaReady) { alert("Please load an image or start the camera first."); return; }
                const media = getActiveMediaElement();
                let naturalWidth, naturalHeight;
                if(state.mode === 'camera') {
                    naturalWidth = media.videoWidth;
                    naturalHeight = media.videoHeight;
                } else {
                    naturalWidth = media.naturalWidth;
                    naturalHeight = media.naturalHeight;
                }

                const newRoi = {
                    id: state.nextRoiId++,
                    name: elements.roiNameInput.value || `ROI-${state.nextRoiId}`,
                    color: elements.roiColorInput.value,
                    shape: elements.roiShapeSelect.value,
                    size: parseInt(elements.roiSizeInput.value) || 50,
                    x: (elements.mediaContainer.scrollLeft + elements.mediaContainer.clientWidth / 2) / state.zoom,
                    y: (elements.mediaContainer.scrollTop + elements.mediaContainer.clientHeight / 2) / state.zoom,
                    type: state.rois.some(r => r.type === 'Calibrator') ? 'Sample' : 'Calibrator',
                };
                state.rois.push(newRoi);
                elements.roiNameInput.value = `ROI-${state.nextRoiId}`;
                updateUI();
            }

            function deleteRoi(id) {
                state.rois = state.rois.filter(roi => roi.id !== id);
                if (state.selectedRoiId === id) state.selectedRoiId = null;
                updateUI();
            }

            function updateAllRoisPosition() {
                state.rois.forEach(roi => {
                    const roiEl = document.getElementById(`roi-${roi.id}`);
                    if (roiEl) {
                        const scrollLeft = elements.mediaContainer.scrollLeft;
                        const scrollTop = elements.mediaContainer.scrollTop;
                        const cssX = roi.x * state.zoom - scrollLeft;
                        const cssY = roi.y * state.zoom - scrollTop;
                        const cssSize = roi.size * state.zoom;
                        roiEl.style.width = `${cssSize}px`;
                        roiEl.style.height = `${cssSize}px`;
                        roiEl.style.left = `${cssX - cssSize / 2}px`;
                        roiEl.style.top = `${cssY - cssSize / 2}px`;
                    }
                });
            }

            function analyzeRoi(roi) {
                if (!state.mediaReady) return null;
                const media = getActiveMediaElement();
                let naturalWidth, naturalHeight;
                if (state.mode === 'camera') {
                    if (!(elements.video.readyState >= 2)) return null;
                    naturalWidth = elements.video.videoWidth; naturalHeight = elements.video.videoHeight;
                } else {
                    if (!(elements.uploadedImage.complete && elements.uploadedImage.naturalWidth > 0)) return null;
                    naturalWidth = elements.uploadedImage.naturalWidth; naturalHeight = elements.uploadedImage.naturalHeight;
                }
                if (naturalWidth === 0) return null;
                elements.canvas.width = naturalWidth;
                elements.canvas.height = naturalHeight;
                elements.ctx.drawImage(media, 0, 0, naturalWidth, naturalHeight);

                let r = 0, g = 0, b = 0, count = 0;
                const radius = roi.size / 2;
                const startX = Math.max(0, Math.floor(roi.x - radius));
                const startY = Math.max(0, Math.floor(roi.y - radius));
                const endX = Math.min(naturalWidth, Math.floor(roi.x + radius));
                const endY = Math.min(naturalHeight, Math.floor(roi.y + radius));
                if (endX <= startX || endY <= startY) return {r:0, g:0, b:0};
                const roiWidth = endX - startX;
                const roiHeight = endY - startY;
                const imageData = elements.ctx.getImageData(startX, startY, roiWidth, roiHeight);
                const data = imageData.data;
                for (let y = 0; y < roiHeight; y++) {
                    for (let x = 0; x < roiWidth; x++) {
                        let include = (roi.shape === 'square') || (Math.pow((startX + x) - roi.x, 2) + Math.pow((startY + y) - roi.y, 2) <= radius * radius);
                        if (include) {
                            const i = (y * roiWidth + x) * 4;
                            r += data[i]; g += data[i+1]; b += data[i+2];
                            count++;
                        }
                    }
                }
                return count > 0 ? { r: r/count, g: g/count, b: b/count } : {r:0, g:0, b:0};
            }

            function handleCalibrate() { 
                const calibratorRoi = state.rois.find(r => r.type === 'Calibrator');
                if (!calibratorRoi) { alert("Please define one ROI as 'Calibrator' type first."); return; }
                const analysis = analyzeRoi(calibratorRoi);
                if (analysis) { 
                    state.blankRgb = {r: analysis.r, g: analysis.g, b: analysis.b}; 
                    state.isCalibrated = true; 
                    updateUI();
                } else { alert("Calibration failed. Ensure Calibrator ROI is within image bounds."); }
            }
            
            function handleRunAnalysis() {
                const mode = elements.analysisModeSelect.value;
                if (mode === 'point') runPointMeasurement();
                else if (mode === 'kinetics') runKinetics();
                else if (mode === 'scan') runSpectralScan();
            }

            function runPointMeasurement() {
                if(!state.isCalibrated) { alert("Please calibrate first."); return; }
                const sampleRois = state.rois.filter(r => r.type === 'Sample');
                if(sampleRois.length === 0) { alert("Please define at least one 'Sample' ROI."); return; }

                const safeLog = (I0, I) => (I > 0 && I0 > 0) ? Math.log10(I0 / I) : 0;
                
                sampleRois.forEach(roi => {
                    const sampleRgb = analyzeRoi(roi);
                    if(sampleRgb) {
                        const abs = {
                            r: safeLog(state.blankRgb.r, sampleRgb.r),
                            g: safeLog(state.blankRgb.g, sampleRgb.g),
                            b: safeLog(state.blankRgb.b, sampleRgb.b)
                        };
                         document.getElementById('absR').textContent = abs.r.toFixed(3);
                         document.getElementById('absG').textContent = abs.g.toFixed(3);
                         document.getElementById('absB').textContent = abs.b.toFixed(3);

                        state.pointWavelengths.forEach(wl => {
                            const targetRgb = wavelengthToRgb(wl);
                            const blankIntensity = (state.blankRgb.r * targetRgb.r + state.blankRgb.g * targetRgb.g + state.blankRgb.b * targetRgb.b);
                            const sampleIntensity = (sampleRgb.r * targetRgb.r + sampleRgb.g * targetRgb.g + sampleRgb.b * targetRgb.b);
                            const wlAbs = safeLog(blankIntensity, sampleIntensity);
                            const el = document.getElementById(`abs_wl_${wl}`);
                            if(el) el.textContent = wlAbs.toFixed(3);
                        });
                    }
                });
            }

            function runKinetics() {
                if (state.isAnalyzing) { // Stop analysis
                    clearInterval(state.kineticsTimer);
                    state.isAnalyzing = false;
                    updateUI();
                    return;
                }
                if(!state.isCalibrated) { alert("Please calibrate first."); return; }
                const sampleRois = state.rois.filter(r => r.type === 'Sample');
                if (sampleRois.length === 0) { alert("Please define at least one 'Sample' ROI."); return; }
                
                state.isAnalyzing = true;
                updateUI();
                state.analysisData = { type: 'kinetics', datasets: sampleRois.map(r => ({label: r.name, data:[], borderColor: r.color, tension: 0.1})) };
                
                let cycle = 0;
                const maxCycles = parseInt(elements.kineticsCyclesInput.value);
                const interval = parseInt(elements.kineticsIntervalInput.value) * 1000;

                const runCycle = () => {
                    const timestamp = new Date();
                    handleCalibrate(); // Recalibrate for each time point
                    sampleRois.forEach((roi, index) => {
                        const sampleRgb = analyzeRoi(roi);
                        if(sampleRgb && state.isCalibrated) {
                            const abs = Math.log10(state.blankRgb.r / sampleRgb.r); // Example using Red channel
                            state.analysisData.datasets[index].data.push({x: timestamp, y: abs});
                        }
                    });
                    
                    updateChart();
                    updateResultsTable();
                    cycle++;
                    if (cycle >= maxCycles) {
                        clearInterval(state.kineticsTimer);
                        state.isAnalyzing = false;
                        updateUI();
                    }
                };
                
                runCycle(); // Run first cycle immediately
                state.kineticsTimer = setInterval(runCycle, interval);
            }

            function runSpectralScan() {
                 if(!state.isCalibrated) { alert("Please calibrate first."); return; }
                const sampleRois = state.rois.filter(r => r.type === 'Sample');
                if (sampleRois.length === 0) { alert("Please define at least one 'Sample' ROI."); return; }
                
                state.isAnalyzing = true;
                updateUI();
                state.analysisData = { type: 'scan', datasets: sampleRois.map(r => ({label: r.name, data:[], borderColor: r.color, tension: 0.1})) };

                const start = parseInt(elements.scanStartInput.value);
                const end = parseInt(elements.scanEndInput.value);
                const step = parseInt(elements.scanStepInput.value);
                const safeLog = (I0, I) => (I > 0 && I0 > 0) ? Math.log10(I0 / I) : 0;
                
                sampleRois.forEach((roi, index) => {
                    const sampleRgb = analyzeRoi(roi);
                    if(sampleRgb){
                        for(let wl = start; wl <= end; wl += step) {
                            const targetRgb = wavelengthToRgb(wl);
                            const blankIntensity = (state.blankRgb.r * targetRgb.r + state.blankRgb.g * targetRgb.g + state.blankRgb.b * targetRgb.b);
                            const sampleIntensity = (sampleRgb.r * targetRgb.r + sampleRgb.g * targetRgb.g + sampleRgb.b * targetRgb.b);
                            const abs = safeLog(blankIntensity, sampleIntensity);
                            state.analysisData.datasets[index].data.push({x: wl, y: abs});
                        }
                    }
                });
                
                updateChart();
                updateResultsTable();
                state.isAnalyzing = false;
                updateUI();
            }
            
            function updateUI() {
                // Main UI update logic
                elements.calibrateBtn.disabled = !state.mediaReady || state.rois.filter(r => r.type === 'Calibrator').length === 0;
                elements.runAnalysisBtn.disabled = !state.isCalibrated || state.rois.filter(r => r.type === 'Sample').length === 0 || state.isAnalyzing;
                elements.runAnalysisBtn.innerHTML = state.isAnalyzing ? '<i class="bi bi-stop-fill"></i> Stop' : '<i class="bi bi-play-fill"></i> Run Analysis';

                // ROI Table
                elements.roiTableBody.innerHTML = '';
                state.rois.forEach(roi => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><span class="color-swatch" style="background-color: ${roi.color};"></span></td>
                        <td>${roi.name}</td>
                        <td><select class="form-select roi-type-select" data-id="${roi.id}"><option>Sample</option><option>Calibrator</option></select></td>
                        <td>${roi.size}px, ${roi.shape}</td>
                        <td><i class="bi bi-trash-fill delete-btn" data-id="${roi.id}"></i></td>
                    `;
                    row.querySelector('.roi-type-select').value = roi.type;
                    elements.roiTableBody.appendChild(row);
                });

                // ROI Overlay
                elements.roiOverlay.innerHTML = '';
                state.rois.forEach(roi => {
                    const el = document.createElement('div');
                    el.id = `roi-${roi.id}`;
                    el.className = 'roi-indicator';
                    el.classList.toggle('circle', roi.shape === 'circle');
                    el.classList.toggle('selected', roi.id === state.selectedRoiId);
                    el.classList.toggle('calibrator', roi.type === 'Calibrator');
                    el.style.borderColor = roi.color;
                    elements.roiOverlay.appendChild(el);
                });

                updateAllRoisPosition();
            }
            
            /**
 * Initializes the application, sets up all event listeners, and configures the chart.
 * This is the main entry point for the application's JavaScript.
 */
function init() {
    // --- Setup and Source Listeners ---
    elements.sourceModeSelect.addEventListener('change', (e) => setMode(e.target.value));
    elements.cameraSelect.addEventListener('change', () => startCamera(elements.cameraSelect.value));
    elements.imageUpload.addEventListener('change', handleImageUpload);
    elements.zoomSlider.addEventListener('input', (e) => {
        state.zoom = parseFloat(e.target.value);
        elements.zoomValue.textContent = `${state.zoom.toFixed(1)}x`;
        const media = getActiveMediaElement();
        if (media) {
            media.style.transform = `scale(${state.zoom})`;
        }
        updateAllRoisPosition();
    });

    // --- Analysis Mode Listener ---
    elements.analysisModeSelect.addEventListener('change', updateUI);

    // --- ROI Definition Listeners ---
    elements.addRoiBtn.addEventListener('click', addRoi);
    elements.roiShapeSelect.addEventListener('change', updateSelectedRoiProperties);
    elements.roiSizeInput.addEventListener('change', updateSelectedRoiProperties);
    
    // Using event delegation for dynamic elements in the ROI table
    elements.roiTableBody.addEventListener('click', (e) => {
        const id = parseInt(e.target.dataset.id, 10);
        if (e.target.classList.contains('delete-btn')) {
            deleteRoi(id);
        } else {
            // Handle row selection for editing
            const row = e.target.closest('tr');
            if (row) {
                const rowId = parseInt(row.dataset.id, 10);
                state.selectedRoiId = rowId;
                const roi = state.rois.find(r => r.id === rowId);
                if (roi) {
                    elements.roiShapeSelect.value = roi.shape;
                    elements.roiSizeInput.value = roi.size;
                }
                updateUI();
            }
        }
    });

    elements.roiTableBody.addEventListener('change', (e) => {
        const id = parseInt(e.target.dataset.id, 10);
        if (e.target.classList.contains('roi-type-select')) {
            const roi = state.rois.find(r => r.id === id);
            if (roi) {
                roi.type = e.target.value;
                // Ensure only one calibrator at a time
                if (roi.type === 'Calibrator') {
                    state.rois.forEach(r => { if (r.id !== roi.id) r.type = 'Sample' });
                }
                updateUI();
            }
        }
    });

    // --- Analysis Execution Listeners ---
    elements.calibrateBtn.addEventListener('click', handleCalibrate);
    elements.runAnalysisBtn.addEventListener('click', handleRunAnalysis);

    // --- Point Measurement Wavelength Listeners ---
    elements.addWavelengthBtn.addEventListener('click', handleAddWavelength);
    elements.pointResultsDiv.addEventListener('click', (e) => {
         if (e.target.classList.contains('delete-btn')) {
            const wl = parseInt(e.target.dataset.wl, 10);
            if (!isNaN(wl)) handleDeleteWavelength(wl);
        }
    });

    // --- Media Interaction (Pan/Zoom/Drag) Listeners ---
    elements.mediaContainer.addEventListener('wheel', handleZoom, { passive: false });
    
    elements.roiOverlay.addEventListener('mousedown', (e) => {
        const target = e.target;
        if (target.classList.contains('roi-indicator')) {
            e.preventDefault();
            state.draggingRoiId = parseInt(target.dataset.id, 10);
            state.selectedRoiId = state.draggingRoiId;
            state.dragStart.x = e.clientX;
            state.dragStart.y = e.clientY;
            updateUI(); // Redraw to show selection
        }
    });

    document.addEventListener('mousemove', (e) => {
        if (state.draggingRoiId === null) return;
        const roi = state.rois.find(r => r.id === state.draggingRoiId);
        if (!roi) return;
        const dx = e.clientX - state.dragStart.x;
        const dy = e.clientY - state.dragStart.y;
        roi.x += dx / state.zoom;
        roi.y += dy / state.zoom;
        state.dragStart.x = e.clientX;
        state.dragStart.y = e.clientY;
        updateAllRoisPosition();
    });

    document.addEventListener('mouseup', () => {
        state.draggingRoiId = null;
    });

    // --- Data Export Listeners ---
    elements.exportChartBtn.addEventListener('click', handleExportChart);
    elements.exportDataBtn.addEventListener('click', handleExportData);

    // --- Window Resize Listener ---
    window.addEventListener('resize', updateAllRoisPosition);

    // --- Initialize Chart.js ---
    chart = new Chart(elements.resultsChartCanvas, {
        type: 'scatter',
        data: { datasets: [] },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false, position: 'top', labels: { color: 'var(--text-primary)', font: { size: 10 } } } },
            scales: {
                x: {
                    title: { display: true, text: 'X-Axis', color: 'var(--text-secondary)' },
                    ticks: { color: 'var(--text-secondary)', font: { size: 10 } },
                    grid: { color: 'var(--border-primary)' }
                },
                y: {
                    title: { display: true, text: 'Y-Axis', color: 'var(--text-secondary)' },
                    ticks: { color: 'var(--text-secondary)', font: { size: 10 } },
                    grid: { color: 'var(--border-primary)' },
                    beginAtZero: true
                }
            }
        }
    });
    
    // --- Initial Application State Setup ---
    getCameras();
    setMode('camera'); 
    updateUI();
}

            init();
        });
    </script>
</body>
</html>


