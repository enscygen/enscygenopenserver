<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Spectrophotometer</title>
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        /* CSS Variables for easy theming */
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --primary-color: #bb86fc;
            --primary-variant-color: #3700b3;
            --secondary-color: #03dac6;
            --text-color: #e0e0e0;
            --text-color-muted: #888;
            --border-color: #333;
            --error-color: #cf6679;
            --font-family: 'Inter', sans-serif;
        }

        /* Basic Reset and Global Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            overflow: hidden; /* Prevent body scrolling */
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 14px;
        }

        /* Main App Layout */
        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr 280px;
            grid-template-rows: auto 1fr auto;
            grid-template-areas:
                "header header header"
                "controls canvas data"
                "results results results";
            height: 100vh;
            gap: 8px;
            padding: 8px;
        }

        .app-header { grid-area: header; }
        .controls-panel { grid-area: controls; }
        .canvas-container { grid-area: canvas; }
        .data-panel { grid-area: data; }
        .results-panel { grid-area: results; }

        /* Panel Styling */
        .panel {
            background-color: var(--surface-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            overflow-y: auto;
        }

        .panel-title {
            font-size: 1.1em;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0; /* Reset default h3 margin */
        }
        
        /* Collapsible Section Styling */
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 8px;
        }
        .collapse-icon {
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }
        .collapsible-content {
            max-height: 500px; /* Adjust as needed */
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            display: flex;
            flex-direction: column;
            gap: 12px; /* Gap for items inside content */
        }
        .collapsible:not(.open) .collapsible-content {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
        .collapsible:not(.open) .collapse-icon {
            transform: rotate(-90deg);
        }

        
        /* Header Styling */
        .app-header {
            text-align: center;
            padding: 4px 0;
            font-size: 1.5em;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        /* Form elements styling */
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        label {
            font-weight: 500;
            color: var(--text-color-muted);
            font-size: 0.9em;
        }

        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 8px;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-color);
            font-size: 0.95em;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: var(--primary-variant-color);
            color: #fff;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        button:hover:not(:disabled) {
            background-color: var(--primary-color);
        }
        button:disabled {
            background-color: #333;
            cursor: not-allowed;
            color: #888;
        }

        .button-secondary {
            background-color: #444;
        }
        .button-secondary:hover {
            background-color: #555;
        }

        .icon-button {
            background: none;
            border: none;
            color: var(--text-color-muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
        }
        .icon-button:hover {
            color: var(--secondary-color);
            background-color: rgba(3, 218, 198, 0.1);
        }


        /* Canvas Container */
        .canvas-container {
            position: relative;
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }
        
        #mainCanvas, #roiCanvas {
            position: absolute;
            top: 0;
            left: 0;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        #videoFeed {
            display: none;
        }

        /* Wavelength List */
        #wavelengthList {
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        #wavelengthList li {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid #fff3;
        }

        #wavelengthList li button {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 0;
            font-size: 1.1em;
            line-height: 1;
        }
        
        /* Live Absorbance Panel */
        #liveAbsorbanceValue {
            font-size: 2em;
            font-weight: 600;
            color: var(--secondary-color);
            text-align: center;
            margin: auto 0;
        }
        
        /* Results Table */
        .results-panel {
            max-height: 30vh;
        }
        #resultsTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        #resultsTable th, #resultsTable td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        #resultsTable thead {
            position: sticky;
            top: 0;
            background: var(--surface-color);
        }
        #resultsTable th {
            font-weight: 600;
            color: var(--text-color-muted);
        }
        .roi-thumbnail {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: 1px solid #555;
        }

        /* Modal styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: var(--surface-color);
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--border-color);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .close-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-color);
            cursor: pointer;
        }
        
        /* Radio button styled groups */
        .radio-group {
            display: flex;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }

        .radio-group input[type="radio"] {
            display: none;
        }

        .radio-group label {
            flex: 1;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            background-color: var(--bg-color);
            color: var(--text-color-muted);
            transition: all 0.2s;
            font-size: 0.9em;
        }

        .radio-group input[type="radio"]:checked + label {
            background-color: var(--primary-variant-color);
            color: white;
        }
        
        /* Flex row for inputs */
        .input-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .input-row > * {
            flex: 1;
        }

        /* Responsive Design */
        @media (max-width: 900px) {
            .app-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto auto 1fr;
                grid-template-areas:
                    "header"
                    "controls"
                    "data"
                    "canvas"
                    "results";
                height: auto;
                overflow-y: auto;
            }
            .panel {
                min-height: auto;
            }
            .canvas-container {
                min-height: 300px;
                height: 50vh;
            }
            .results-panel {
                max-height: none;
            }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <header class="app-header">Image Spectrophotometer</header>

        <!-- CONTROLS PANEL (LEFT) -->
        <aside class="panel controls-panel">
            <section class="collapsible open">
                <div class="collapsible-header">
                    <h3 class="panel-title"><i class="bi bi-camera"></i> Source</h3>
                    <i class="bi bi-chevron-up collapse-icon"></i>
                </div>
                <div class="collapsible-content">
                    <div class="form-group">
                        <div class="radio-group">
                            <input type="radio" id="sourceUpload" name="source" value="upload" checked>
                            <label for="sourceUpload"><i class="bi bi-upload"></i> Upload</label>
                            <input type="radio" id="sourceCamera" name="source" value="camera">
                            <label for="sourceCamera"><i class="bi bi-camera-video"></i> Camera</label>
                        </div>
                        <input type="file" id="imageLoader" accept="image/*" style="display: none;">
                        <button id="uploadButton" class="button-secondary">Select Image</button>
                    </div>
                </div>
            </section>
            
            <section class="collapsible open">
                <div class="collapsible-header">
                    <h3 class="panel-title"><i class="bi bi-plus-circle-dotted"></i> ROI Selection</h3>
                    <i class="bi bi-chevron-up collapse-icon"></i>
                </div>
                <div class="collapsible-content">
                    <div class="form-group">
                        <label>ROI Type</label>
                        <div class="radio-group">
                            <input type="radio" id="roiTypeBlank" name="roiType" value="blank">
                            <label for="roiTypeBlank">Blank</label>
                            <input type="radio" id="roiTypeSample" name="roiType" value="sample" checked>
                            <label for="roiTypeSample">Sample</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="roiShape">Shape</label>
                        <select id="roiShape">
                            <option value="square">Square</option>
                            <option value="circle">Circle</option>
                            <option value="pixel">Pixel</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="roiSize">Size (px)</label>
                        <input type="number" id="roiSize" value="20" min="1" max="500">
                    </div>
                    <div class="form-group">
                        <label for="roiName">Name (Optional)</label>
                        <input type="text" id="roiName" placeholder="Auto (e.g., Sample 1)">
                    </div>
                    <small style="color:var(--text-color-muted); text-align:center;">Click on the image to place an ROI.</small>
                </div>
            </section>
            
            <section class="collapsible open">
                <div class="collapsible-header">
                    <h3 class="panel-title"><i class="bi bi-स्पेक्ट्रोमीटर"></i> Wavelengths (nm)</h3>
                    <i class="bi bi-chevron-up collapse-icon"></i>
                </div>
                <div class="collapsible-content">
                    <div class="form-group">
                         <div class="input-row">
                            <input type="number" id="wavelengthInput" placeholder="e.g., 540" min="380" max="780">
                            <button id="addWavelengthBtn">Add</button>
                        </div>
                    </div>
                    <ul id="wavelengthList"></ul>
                </div>
            </section>
        </aside>

        <!-- CANVAS (CENTER) -->
        <main class="canvas-container">
            <video id="videoFeed" autoplay playsinline></video>
            <canvas id="mainCanvas"></canvas>
            <canvas id="roiCanvas"></canvas>
            <p id="canvas-placeholder" style="color:var(--text-color-muted);">Upload an image or start the camera</p>
        </main>

        <!-- DATA & MEASUREMENT (RIGHT) -->
        <aside class="panel data-panel">
            <section class="collapsible open">
                <div class="collapsible-header">
                    <h3 class="panel-title"><i class="bi bi-graph-up"></i> Live Absorbance</h3>
                    <i class="bi bi-chevron-up collapse-icon"></i>
                </div>
                <div class="collapsible-content">
                    <div id="liveAbsorbanceValue">-</div>
                    <small style="color:var(--text-color-muted); text-align:center;" id="liveAbsorbanceInfo">No Blank ROI set</small>
                </div>
            </section>
            
            <section class="collapsible open">
                <div class="collapsible-header">
                    <h3 class="panel-title"><i class="bi bi-gear"></i> Measurement Mode</h3>
                    <i class="bi bi-chevron-up collapse-icon"></i>
                </div>
                <div class="collapsible-content">
                     <div class="form-group">
                        <select id="measurementMode">
                            <option value="static">Static Absorbance at Point</option>
                            <option value="series">Series Wavelength Scan</option>
                            <option value="time">Absorbance at Time Points</option>
                        </select>
                    </div>
                    <div id="series-scan-options" class="form-group" style="display:none;">
                        <label>Wavelength Range (nm)</label>
                        <div class="input-row">
                            <input type="number" id="seriesStart" placeholder="Start" value="400">
                            <input type="number" id="seriesEnd" placeholder="End" value="700">
                        </div>
                         <input type="number" id="seriesStep" placeholder="Step" value="10">
                    </div>
                    <div id="time-series-options" class="form-group" style="display:none;">
                        <label>Time Points (seconds, comma-separated)</label>
                        <input type="text" id="timePoints" placeholder="e.g. 0, 30, 60, 120" value="0, 5, 10">
                    </div>
                     <button id="startMeasurementBtn">Start Measurement</button>
                </div>
            </section>
        </aside>

        <!-- RESULTS TABLE (BOTTOM) -->
        <footer class="panel results-panel">
             <section class="collapsible open">
                 <div class="collapsible-header">
                    <h3 class="panel-title"><i class="bi bi-table"></i> ROI Data</h3>
                    <i class="bi bi-chevron-up collapse-icon"></i>
                </div>
                <div class="collapsible-content">
                     <div style="overflow-x: auto; width: 100%;">
                         <table id="resultsTable">
                            <thead>
                                <tr>
                                    <th>ROI</th>
                                    <th>Name</th>
                                    <!-- Wavelength headers will be added dynamically -->
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- ROI rows will be added dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </footer>

    </div>
    
    <!-- MODALS -->
    <div id="roiEditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit ROI</h2>
                <button class="close-button">&times;</button>
            </div>
            <div class="form-group">
                <label for="editRoiName">Name</label>
                <input type="text" id="editRoiName">
            </div>
            <div class="form-group">
                <label for="editRoiShape">Shape</label>
                <select id="editRoiShape">
                    <option value="square">Square</option>
                    <option value="circle">Circle</option>
                    <option value="pixel">Pixel</option>
                </select>
            </div>
            <div class="form-group">
                <label for="editRoiSize">Size</label>
                <input type="number" id="editRoiSize" min="1">
            </div>
            <div class="form-group">
                <label for="editRoiColor">Border Color</label>
                <input type="color" id="editRoiColor" style="width:100%; height: 40px; padding: 0;">
            </div>
            <button id="saveRoiChangesBtn" style="margin-top: 20px;">Save Changes</button>
        </div>
    </div>
    
    <div id="roiInfoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ROI Information</h2>
                <button class="close-button">&times;</button>
            </div>
            <div id="roiInfoContent"></div>
        </div>
    </div>

    <div id="chartModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="chartTitle">Measurement Chart</h2>
                <button class="close-button">&times;</button>
            </div>
            <canvas id="measurementChart"></canvas>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Element References
            const imageLoader = document.getElementById('imageLoader');
            const uploadButton = document.getElementById('uploadButton');
            const mainCanvas = document.getElementById('mainCanvas');
            const roiCanvas = document.getElementById('roiCanvas');
            const videoFeed = document.getElementById('videoFeed');
            const canvasPlaceholder = document.getElementById('canvas-placeholder');
            const mainCtx = mainCanvas.getContext('2d', { willReadFrequently: true });
            const roiCtx = roiCanvas.getContext('2d');
            const sourceRadios = document.querySelectorAll('input[name="source"]');
            
            const wavelengthInput = document.getElementById('wavelengthInput');
            const addWavelengthBtn = document.getElementById('addWavelengthBtn');
            const wavelengthList = document.getElementById('wavelengthList');

            const roiTypeRadios = document.querySelectorAll('input[name="roiType"]');
            const roiShapeSelect = document.getElementById('roiShape');
            const roiSizeInput = document.getElementById('roiSize');
            const roiNameInput = document.getElementById('roiName');

            const liveAbsorbanceValue = document.getElementById('liveAbsorbanceValue');
            const liveAbsorbanceInfo = document.getElementById('liveAbsorbanceInfo');
            
            const measurementModeSelect = document.getElementById('measurementMode');
            const seriesScanOptions = document.getElementById('series-scan-options');
            const timeSeriesOptions = document.getElementById('time-series-options');
            const startMeasurementBtn = document.getElementById('startMeasurementBtn');
            
            const resultsTableBody = document.querySelector('#resultsTable tbody');
            const resultsTableHead = document.querySelector('#resultsTable thead tr');

            // Modals
            const roiEditModal = document.getElementById('roiEditModal');
            const roiInfoModal = document.getElementById('roiInfoModal');
            const chartModal = document.getElementById('chartModal');
            const saveRoiChangesBtn = document.getElementById('saveRoiChangesBtn');
            const editRoiName = document.getElementById('editRoiName');
            const editRoiShape = document.getElementById('editRoiShape');
            const editRoiSize = document.getElementById('editRoiSize');
            const editRoiColor = document.getElementById('editRoiColor');
            let currentlyEditingRoiId = null;

            // App State
            let appState = {
                sourceType: 'upload', // 'upload' or 'camera'
                rois: [],
                wavelengths: [540], // Default wavelength
                blankRoiId: null,
                nextSampleId: 1,
                isDragging: false,
                draggedRoi: null,
                dragOffsetX: 0,
                dragOffsetY: 0,
                videoStream: null,
                measurementChart: null,
                isMeasuring: false,
            };

            // --- CORE LOGIC ---

            function wavelengthToRgb(lambda) {
                let r, g, b;
                if (lambda >= 380 && lambda <= 439) {
                    r = -(lambda - 440) / (440 - 380); g = 0.0; b = 1.0;
                } else if (lambda >= 440 && lambda <= 489) {
                    r = 0.0; g = (lambda - 440) / (490 - 440); b = 1.0;
                } else if (lambda >= 490 && lambda <= 509) {
                    r = 0.0; g = 1.0; b = -(lambda - 510) / (510 - 490);
                } else if (lambda >= 510 && lambda <= 579) {
                    r = (lambda - 510) / (580 - 510); g = 1.0; b = 0.0;
                } else if (lambda >= 580 && lambda <= 644) {
                    r = 1.0; g = -(lambda - 645) / (645 - 580); b = 0.0;
                } else if (lambda >= 645 && lambda <= 780) {
                    r = 1.0; g = 0.0; b = 0.0;
                } else {
                    r = 0.0; g = 0.0; b = 0.0;
                }

                let factor;
                if (lambda >= 380 && lambda <= 419) {
                    factor = 0.3 + 0.7 * (lambda - 380) / (420 - 380);
                } else if (lambda >= 420 && lambda <= 700) {
                    factor = 1.0;
                } else if (lambda >= 701 && lambda <= 780) {
                    factor = 0.3 + 0.7 * (780 - lambda) / (780 - 700);
                } else {
                    factor = 0.0;
                }

                const gamma = 0.8;
                const adjust = (color) => Math.round(255 * Math.pow(color * factor, gamma));
                return { r: adjust(r), g: adjust(g), b: adjust(b) };
            }

            function getRoiAverageColor(roi) {
                if (!mainCanvas.width || !mainCanvas.height) return null;

                const size = roi.shape === 'pixel' ? 1 : roi.size;
                const halfSize = size / 2;
                const startX = Math.round(roi.x - halfSize);
                const startY = Math.round(roi.y - halfSize);

                if (startX + size < 0 || startX > mainCanvas.width || startY + size < 0 || startY > mainCanvas.height) {
                    return null;
                }

                const imageData = mainCtx.getImageData(Math.max(0, startX), Math.max(0, startY), Math.min(size, mainCanvas.width - startX), Math.min(size, mainCanvas.height - startY));
                const data = imageData.data;
                let r = 0, g = 0, b = 0, count = 0;

                for (let i = 0; i < data.length; i += 4) {
                    const pixelX = Math.max(0, startX) + (i / 4) % imageData.width;
                    const pixelY = Math.max(0, startY) + Math.floor((i / 4) / imageData.width);

                    let inShape = false;
                    if (roi.shape === 'square' || roi.shape === 'pixel') {
                        inShape = true;
                    } else if (roi.shape === 'circle') {
                        const dx = pixelX - roi.x;
                        const dy = pixelY - roi.y;
                        if (dx * dx + dy * dy <= halfSize * halfSize) {
                            inShape = true;
                        }
                    }

                    if (inShape) {
                        r += data[i];
                        g += data[i + 1];
                        b += data[i + 2];
                        count++;
                    }
                }

                if (count === 0) return { r: 0, g: 0, b: 0, count: 0 };
                return { r: r / count, g: g / count, b: b / count, count };
            }

            function calculateAllAbsorbances() {
                const blankRoi = appState.rois.find(r => r.id === appState.blankRoiId);
                if (!blankRoi) {
                    liveAbsorbanceInfo.textContent = "No Blank ROI set";
                    // Reset all sample absorbances
                    appState.rois.filter(r => r.type === 'sample').forEach(sampleRoi => {
                        sampleRoi.absorbance = {};
                    });
                    updateResultsTable();
                    return;
                }

                liveAbsorbanceInfo.textContent = `Blank: ${blankRoi.name}`;
                const blankColor = getRoiAverageColor(blankRoi);
                if (!blankColor) return;
                
                const blankIntensityByWavelength = {};
                appState.wavelengths.forEach(wl => {
                    blankIntensityByWavelength[wl] = 0.299 * blankColor.r + 0.587 * blankColor.g + 0.114 * blankColor.b;
                });

                appState.rois.forEach(roi => {
                    if (roi.type === 'sample') {
                        const sampleColor = getRoiAverageColor(roi);
                        if (!sampleColor) {
                            roi.absorbance = {};
                            return;
                        }
                        
                        appState.wavelengths.forEach(wl => {
                            const sampleIntensity = 0.299 * sampleColor.r + 0.587 * sampleColor.g + 0.114 * sampleColor.b;
                            const blankIntensity = blankIntensityByWavelength[wl];
                            
                            if (blankIntensity > 0 && sampleIntensity > 0) {
                                const transmittance = sampleIntensity / blankIntensity;
                                roi.absorbance[wl] = -Math.log10(transmittance).toFixed(3);
                            } else {
                                roi.absorbance[wl] = 'inf';
                            }
                        });
                    }
                });

                const firstSample = appState.rois.find(r => r.type === 'sample');
                if(firstSample && appState.wavelengths.length > 0){
                    const firstWl = appState.wavelengths[0];
                    liveAbsorbanceValue.textContent = firstSample.absorbance[firstWl] || '-';
                } else {
                    liveAbsorbanceValue.textContent = '-';
                }

                updateResultsTable();
            }


            // --- UI & EVENT LISTENERS ---

            document.querySelectorAll('.collapsible-header').forEach(header => {
                header.addEventListener('click', () => {
                    const collapsible = header.closest('.collapsible');
                    collapsible.classList.toggle('open');
                });
            });

            function drawROIs() {
                roiCtx.clearRect(0, 0, roiCanvas.width, roiCanvas.height);
                appState.rois.forEach(roi => {
                    const size = roi.shape === 'pixel' ? 5 : roi.size; // Draw pixels larger to be visible
                    const halfSize = size / 2;
                    roiCtx.strokeStyle = roi.color;
                    roiCtx.lineWidth = 2;
                    roiCtx.fillStyle = `${roi.color}33`; // semi-transparent fill
                    roiCtx.font = "12px Arial";
                    roiCtx.textAlign = "center";

                    roiCtx.beginPath();
                    if (roi.shape === 'circle') {
                        roiCtx.arc(roi.x, roi.y, halfSize, 0, Math.PI * 2);
                    } else { // square or pixel
                        roiCtx.rect(roi.x - halfSize, roi.y - halfSize, size, size);
                    }
                    roiCtx.stroke();
                    roiCtx.fill();
                    
                    roiCtx.fillStyle = roi.color;
                    roiCtx.fillText(roi.name, roi.x, roi.y - halfSize - 5);
                });
            }

            function updateWavelengthList() {
                wavelengthList.innerHTML = '';
                appState.wavelengths.forEach(wl => {
                    const rgb = wavelengthToRgb(wl);
                    const li = document.createElement('li');
                    li.style.backgroundColor = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
                    const brightness = (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000;
                    li.style.color = brightness > 128 ? '#000' : '#fff';
                    li.innerHTML = `${wl} nm <button data-wl="${wl}" class="delete-wl">&times;</button>`;
                    wavelengthList.appendChild(li);
                });
                updateResultsTableHeader();
            }
            
            function updateResultsTableHeader() {
                resultsTableHead.innerHTML = `<th>ROI</th><th>Name</th>${appState.wavelengths.map(wl => `<th>${wl} nm</th>`).join('')}<th>Actions</th>`;
            }

            function updateResultsTable() {
                resultsTableBody.innerHTML = '';
                appState.rois.forEach(roi => {
                    const tr = document.createElement('tr');
                    const thumbnailCanvas = document.createElement('canvas');
                    thumbnailCanvas.width = 24;
                    thumbnailCanvas.height = 24;
                    const thumbCtx = thumbnailCanvas.getContext('2d');
                    const avgColor = getRoiAverageColor(roi) || {r:0, g:0, b:0};
                    thumbCtx.fillStyle = `rgb(${avgColor.r}, ${avgColor.g}, ${avgColor.b})`;
                    thumbCtx.fillRect(0, 0, 24, 24);
                    const absorbanceCells = appState.wavelengths.map(wl => `<td>${roi.absorbance ? (roi.absorbance[wl] || '-') : '-'}</td>`).join('');
                    tr.innerHTML = `<td><img src="${thumbnailCanvas.toDataURL()}" class="roi-thumbnail"></td><td>${roi.name}</td>${absorbanceCells}<td><button class="icon-button edit-roi-btn" data-id="${roi.id}" title="Edit"><i class="bi bi-pencil"></i></button><button class="icon-button info-roi-btn" data-id="${roi.id}" title="Info"><i class="bi bi-info-circle"></i></button><button class="icon-button chart-roi-btn" data-id="${roi.id}" title="Chart" style="display: ${measurementModeSelect.value === 'series' ? 'inline-block' : 'none'};"><i class="bi bi-bar-chart"></i></button><button class="icon-button delete-roi-btn" data-id="${roi.id}" title="Delete"><i class="bi bi-trash"></i></button></td>`;
                    resultsTableBody.appendChild(tr);
                });
            }

            function handleImageUpload(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.onload = () => {
                            setCanvasSize(img.width, img.height);
                            mainCtx.drawImage(img, 0, 0);
                            canvasPlaceholder.style.display = 'none';
                            calculateAllAbsorbances();
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            }

            async function startCamera() {
                try {
                    if (appState.videoStream) {
                        appState.videoStream.getTracks().forEach(track => track.stop());
                    }
                    appState.videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    videoFeed.srcObject = appState.videoStream;
                    videoFeed.onloadedmetadata = () => {
                        setCanvasSize(videoFeed.videoWidth, videoFeed.videoHeight);
                        canvasPlaceholder.style.display = 'none';
                        requestAnimationFrame(drawVideoFrame);
                    };
                } catch (err) {
                    console.error("Error accessing camera:", err);
                    alert("Could not access camera. Please check permissions.");
                }
            }
            
            function stopCamera() {
                if(appState.videoStream) {
                    appState.videoStream.getTracks().forEach(track => track.stop());
                    appState.videoStream = null;
                }
            }

            function drawVideoFrame() {
                if (appState.sourceType === 'camera' && !videoFeed.paused && !videoFeed.ended && !appState.isMeasuring) {
                    mainCtx.drawImage(videoFeed, 0, 0, mainCanvas.width, mainCanvas.height);
                    calculateAllAbsorbances();
                    requestAnimationFrame(drawVideoFrame);
                }
            }
            
            function setCanvasSize(width, height) {
                mainCanvas.width = roiCanvas.width = width;
                mainCanvas.height = roiCanvas.height = height;
                drawROIs();
            }

            uploadButton.addEventListener('click', () => imageLoader.click());
            imageLoader.addEventListener('change', handleImageUpload);

            sourceRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    appState.sourceType = e.target.value;
                    if (appState.sourceType === 'camera') {
                        startCamera();
                        uploadButton.style.display = 'none';
                        imageLoader.style.display = 'none';
                    } else {
                        stopCamera();
                        uploadButton.style.display = 'block';
                        imageLoader.style.display = 'block';
                    }
                });
            });

            addWavelengthBtn.addEventListener('click', () => {
                const wl = parseInt(wavelengthInput.value);
                if (wl >= 380 && wl <= 780 && !appState.wavelengths.includes(wl)) {
                    appState.wavelengths.push(wl);
                    appState.wavelengths.sort((a,b)=>a-b);
                    wavelengthInput.value = '';
                    updateWavelengthList();
                    calculateAllAbsorbances();
                }
            });

            wavelengthList.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-wl')) {
                    const wlToRemove = parseInt(e.target.dataset.wl);
                    appState.wavelengths = appState.wavelengths.filter(wl => wl !== wlToRemove);
                    updateWavelengthList();
                    calculateAllAbsorbances();
                }
            });
            
            roiCanvas.addEventListener('mousedown', (e) => {
                const rect = roiCanvas.getBoundingClientRect();
                const scaleX = roiCanvas.width / rect.width;
                const scaleY = roiCanvas.height / rect.height;
                const x = (e.clientX - rect.left) * scaleX;
                const y = (e.clientY - rect.top) * scaleY;

                let clickedOnRoi = false;
                for (let i = appState.rois.length - 1; i >= 0; i--) {
                    const roi = appState.rois[i];
                    const dist = Math.sqrt(Math.pow(x - roi.x, 2) + Math.pow(y - roi.y, 2));
                    if (dist < roi.size / 2) {
                        appState.isDragging = true;
                        appState.draggedRoi = roi;
                        appState.dragOffsetX = x - roi.x;
                        appState.dragOffsetY = y - roi.y;
                        clickedOnRoi = true;
                        break;
                    }
                }
                
                if(!clickedOnRoi && mainCanvas.width > 0) {
                   addRoi(x,y);
                }
            });

            roiCanvas.addEventListener('mousemove', (e) => {
                if (appState.isDragging && appState.draggedRoi) {
                    const rect = roiCanvas.getBoundingClientRect();
                    const scaleX = roiCanvas.width / rect.width;
                    const scaleY = roiCanvas.height / rect.height;
                    const x = (e.clientX - rect.left) * scaleX;
                    const y = (e.clientY - rect.top) * scaleY;

                    appState.draggedRoi.x = x - appState.dragOffsetX;
                    appState.draggedRoi.y = y - appState.dragOffsetY;
                    
                    appState.draggedRoi.x = Math.max(0, Math.min(mainCanvas.width, appState.draggedRoi.x));
                    appState.draggedRoi.y = Math.max(0, Math.min(mainCanvas.height, appState.draggedRoi.y));
                    
                    drawROIs();
                    calculateAllAbsorbances();
                }
            });

            window.addEventListener('mouseup', () => {
                appState.isDragging = false;
                appState.draggedRoi = null;
            });
            
            resultsTableBody.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                
                const id = button.dataset.id;
                
                if(button.classList.contains('delete-roi-btn')) {
                    appState.rois = appState.rois.filter(roi => roi.id !== id);
                    if(appState.blankRoiId === id) appState.blankRoiId = null;
                    drawROIs();
                    calculateAllAbsorbances();
                } else if(button.classList.contains('edit-roi-btn')) {
                    openEditModal(id);
                } else if(button.classList.contains('info-roi-btn')) {
                    openInfoModal(id);
                } else if(button.classList.contains('chart-roi-btn')) {
                    const roi = appState.rois.find(r => r.id === id);
                    if(roi && roi.seriesData) {
                         showChart(roi.seriesData, 'Wavelength (nm)', 'Absorbance', `${roi.name} - Wavelength Scan`);
                    }
                }
            });
            
            measurementModeSelect.addEventListener('change', (e) => {
                seriesScanOptions.style.display = e.target.value === 'series' ? 'block' : 'none';
                timeSeriesOptions.style.display = e.target.value === 'time' ? 'block' : 'none';
                document.querySelectorAll('.chart-roi-btn').forEach(btn => {
                    btn.style.display = e.target.value === 'series' ? 'inline-block' : 'none';
                })
            });
            
            startMeasurementBtn.addEventListener('click', handleStartMeasurement);
            
            function addRoi(x, y) {
                const type = document.querySelector('input[name="roiType"]:checked').value;
                const id = 'roi-' + Date.now();
                const name = roiNameInput.value || (type === 'blank' ? 'Blank' : `Sample ${appState.nextSampleId++}`);
                
                const newRoi = {
                    id: id, name: name, type: type, shape: roiShapeSelect.value,
                    size: parseInt(roiSizeInput.value), x: x, y: y,
                    color: type === 'blank' ? '#03dac6' : '#bb86fc', absorbance: {}
                };

                if (type === 'blank') {
                    appState.rois = appState.rois.filter(r => r.type !== 'blank');
                    appState.blankRoiId = id;
                }
                
                appState.rois.push(newRoi);
                roiNameInput.value = '';
                
                drawROIs();
                calculateAllAbsorbances();
            }
            
            function openEditModal(id) {
                const roi = appState.rois.find(r => r.id === id);
                if(roi) {
                    currentlyEditingRoiId = id;
                    editRoiName.value = roi.name;
                    editRoiShape.value = roi.shape;
                    editRoiSize.value = roi.size;
                    editRoiColor.value = roi.color;
                    roiEditModal.style.display = 'flex';
                }
            }

            saveRoiChangesBtn.addEventListener('click', () => {
                const roi = appState.rois.find(r => r.id === currentlyEditingRoiId);
                if(roi) {
                    roi.name = editRoiName.value;
                    roi.shape = editRoiShape.value;
                    roi.size = parseInt(editRoiSize.value);
                    roi.color = editRoiColor.value;
                    
                    if(roi.type === 'blank') {
                        roi.color = '#03dac6';
                    }

                    drawROIs();
                    calculateAllAbsorbances();
                    closeAllModals();
                }
            });
            
            function openInfoModal(id) {
                const roi = appState.rois.find(r => r.id === id);
                if (roi) {
                    const avgColor = getRoiAverageColor(roi);
                    const content = document.getElementById('roiInfoContent');
                    content.innerHTML = `<p><strong>Name:</strong> ${roi.name}</p><p><strong>Type:</strong> ${roi.type}</p><p><strong>Shape:</strong> ${roi.shape}</p><p><strong>Size:</strong> ${roi.size}px</p><p><strong>Position (X, Y):</strong> ${roi.x.toFixed(0)}, ${roi.y.toFixed(0)}</p><hr style="margin: 10px 0; border-color: var(--border-color);"><p><strong>Pixels in ROI:</strong> ${avgColor ? avgColor.count : 'N/A'}</p><p><strong>Average Color:</strong> <span style="display:inline-block; width: 16px; height: 16px; background-color: rgb(${avgColor.r.toFixed(0)}, ${avgColor.g.toFixed(0)}, ${avgColor.b.toFixed(0)}); border: 1px solid #fff; vertical-align: middle;"></span> R:${avgColor.r.toFixed(1)}, G:${avgColor.g.toFixed(1)}, B:${avgColor.b.toFixed(1)}</p>`;
                    roiInfoModal.style.display = 'flex';
                }
            }

            function closeAllModals() {
                document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');
                currentlyEditingRoiId = null;
            }

            document.querySelectorAll('.modal .close-button').forEach(btn => {
                btn.addEventListener('click', closeAllModals);
            });
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    closeAllModals();
                }
            });
            
            async function handleStartMeasurement() {
                if(appState.isMeasuring) return;
                appState.isMeasuring = true;
                startMeasurementBtn.disabled = true;

                const mode = measurementModeSelect.value;
                try {
                    if(mode === 'series') {
                        startMeasurementBtn.textContent = 'Scanning...';
                        await runSeriesScan();
                    } else if(mode === 'time') {
                        await runTimeSeries();
                    }
                } catch(e) {
                    console.error("Measurement failed: ", e);
                    alert("An error occurred during measurement.");
                } finally {
                    appState.isMeasuring = false;
                    startMeasurementBtn.textContent = 'Start Measurement';
                    startMeasurementBtn.disabled = false;
                }
            }

            function runSeriesScan() {
                return new Promise(resolve => {
                    const sampleRoi = appState.rois.find(r => r.type === 'sample');
                    if(!sampleRoi) { alert("Please add at least one Sample ROI."); return resolve(); }
                    const blankRoi = appState.rois.find(r => r.id === appState.blankRoiId);
                    if(!blankRoi) { alert("Please set a Blank ROI."); return resolve(); }
                    const start = parseInt(document.getElementById('seriesStart').value);
                    const end = parseInt(document.getElementById('seriesEnd').value);
                    const step = parseInt(document.getElementById('seriesStep').value);
                    const blankColor = getRoiAverageColor(blankRoi);
                    const sampleColor = getRoiAverageColor(sampleRoi);
                    const seriesData = { labels: [], datasets: [{ label: 'Absorbance', data: [], borderColor: '#03dac6', tension: 0.1 }] };
                    for(let wl = start; wl <= end; wl += step) {
                        const blankIntensity = 0.299 * blankColor.r + 0.587 * blankColor.g + 0.114 * blankColor.b;
                        const sampleIntensity = 0.299 * sampleColor.r + 0.587 * sampleColor.g + 0.114 * sampleColor.b;
                        let absorbance = 0;
                        if(blankIntensity > 0 && sampleIntensity > 0) { absorbance = -Math.log10(sampleIntensity / blankIntensity); }
                        seriesData.labels.push(wl);
                        seriesData.datasets[0].data.push(absorbance);
                    }
                    sampleRoi.seriesData = seriesData;
                    showChart(seriesData, 'Wavelength (nm)', 'Absorbance', `${sampleRoi.name} - Wavelength Scan`);
                    resolve();
                });
            }
            
            function runTimeSeries() {
                 return new Promise((resolve) => {
                    if (appState.sourceType !== 'camera') {
                        alert("Time series measurement requires the live camera source.");
                        return resolve();
                    }
                    const sampleRoi = appState.rois.find(r => r.type === 'sample');
                    if(!sampleRoi || !appState.blankRoiId) {
                        alert("Please set one Blank and at least one Sample ROI.");
                        return resolve();
                    }
                    const timePointsInput = document.getElementById('timePoints').value;
                    const timePoints = timePointsInput.split(',').map(t => parseFloat(t.trim())).filter(t => !isNaN(t) && t >= 0).sort((a, b) => a - b);
                    if (timePoints.length === 0) {
                        alert("Please enter valid, comma-separated time points.");
                        return resolve();
                    }
                    const timeData = { labels: [], datasets: [] };
                    appState.wavelengths.forEach(wl => {
                        const rgb = wavelengthToRgb(wl);
                        timeData.datasets.push({ label: `${wl} nm`, data: [], borderColor: `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`, tension: 0.1, pointRadius: 4 });
                    });
                    showChart(timeData, 'Time (s)', 'Absorbance', 'Time Series Measurement');
                    let currentIndex = 0;
                    function takeMeasurementAtNextPoint() {
                        if (currentIndex >= timePoints.length) {
                            startMeasurementBtn.textContent = 'Start Measurement';
                            resolve();
                            return;
                        }
                        const targetTime = timePoints[currentIndex];
                        const previousTime = currentIndex > 0 ? timePoints[currentIndex - 1] : 0;
                        const delay = (targetTime - previousTime) * 1000;
                        startMeasurementBtn.textContent = `Waiting for ${targetTime}s...`;
                        setTimeout(() => {
                            startMeasurementBtn.textContent = `Measuring at ${targetTime}s...`;
                            mainCtx.drawImage(videoFeed, 0, 0, mainCanvas.width, mainCanvas.height);
                            calculateAllAbsorbances();
                            timeData.labels.push(targetTime);
                            appState.wavelengths.forEach((wl, index) => {
                                 while(timeData.datasets[index].data.length < currentIndex) {
                                     timeData.datasets[index].data.push(null);
                                 }
                                 timeData.datasets[index].data.push(sampleRoi.absorbance[wl] || 0);
                            });
                            appState.measurementChart.update();
                            currentIndex++;
                            takeMeasurementAtNextPoint();
                        }, delay);
                    }
                    takeMeasurementAtNextPoint();
                 });
            }
            
            function showChart(data, xLabel, yLabel, titleText) {
                const chartCanvas = document.getElementById('measurementChart');
                if(appState.measurementChart) {
                    appState.measurementChart.destroy();
                }
                document.getElementById('chartTitle').textContent = titleText;
                appState.measurementChart = new Chart(chartCanvas, {
                    type: 'line',
                    data: data,
                    options: {
                        responsive: true,
                        scales: {
                            x: { title: { display: true, text: xLabel, color: '#fff' }, ticks: { color: '#aaa' }, grid: { color: '#444' } },
                            y: { title: { display: true, text: yLabel, color: '#fff' }, ticks: { color: '#aaa' }, grid: { color: '#444' } }
                        },
                        plugins: { legend: { labels: { color: '#fff' } } }
                    }
                });
                chartModal.style.display = 'flex';
            }

            function init() {
                updateWavelengthList();
                calculateAllAbsorbances();
                console.log("Spectrophotometer Initialized");
            }

            init();

        });
    </script>

</body>
</html>


