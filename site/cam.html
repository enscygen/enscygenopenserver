<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>GPS Stamp Camera</title>
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        /* --- Base Styles & Resets --- */
        :root {
            --bg-color: #000000;
            --primary-text: #ffffff;
            --secondary-text: #b0b0b0;
            --accent-color: #ffffff;
            --overlay-bg: rgba(0, 0, 0, 0.75);
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--primary-text);
            -webkit-tap-highlight-color: transparent; /* Disable tap highlight on mobile */
        }

        /* --- Main App Container --- */
        #app-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #camera-feed {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Fills the screen without distortion */
            background-color: #000; /* Black background for fallback */
        }
        
        /* --- Loading & Permission Messages --- */
        #message-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            font-size: 14px;
            z-index: 100;
            transition: opacity 0.3s ease;
        }
        #message-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #skip-camera-btn {
            background-color: transparent;
            color: var(--secondary-text);
            border: 1px solid var(--secondary-text);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            font-weight: 500;
            margin-top: 20px;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        #skip-camera-btn:hover {
            background-color: var(--secondary-text);
            color: var(--bg-color);
        }

        /* --- GPS Info Overlay --- */
        #info-overlay {
            position: absolute;
            bottom: 85px; /* Position above capture button */
            left: 0;
            width: 100%;
            padding: 10px 12px;
            background: var(--overlay-bg);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            color: var(--primary-text);
            display: flex;
            align-items: center;
            gap: 12px;
            transition: opacity 0.3s ease;
        }

        #map-container {
            flex-shrink: 0;
            width: 70px;
            height: 70px;
            border-radius: 8px;
            overflow: hidden;
            background-color: #333;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #map-thumbnail {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #details-container {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 11px;
            font-weight: 500;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--secondary-text);
        }
        
        .detail-item i {
            font-size: 12px;
            color: var(--primary-text);
        }
        
        .detail-item span {
            color: var(--primary-text);
        }
        
        #address {
           white-space: normal;
           display: -webkit-box;
           -webkit-line-clamp: 2;
           -webkit-box-orient: vertical;  
           overflow: hidden;
        }


        /* --- Capture Button --- */
        #capture-btn {
            position: absolute;
            bottom: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--accent-color);
            border: 4px solid var(--bg-color);
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            transition: transform 0.1s ease-out, background-color 0.3s ease;
        }
        
        #capture-btn:active {
            transform: scale(0.95);
        }
        
        #capture-btn:disabled {
            background-color: #555;
            cursor: not-allowed;
            box-shadow: none;
        }


        /* --- Result Modal --- */
        #result-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        #result-modal.hidden {
            display: none;
        }

        #result-image {
            max-width: 95vw;
            max-height: 75vh;
            border-radius: 8px;
            border: 2px solid #333;
        }
        
        .modal-actions {
            margin-top: 20px;
            display: flex;
            gap: 15px;
        }
        
        .modal-btn {
            background-color: #333;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .modal-btn.primary {
            background-color: #fff;
            color: #000;
        }

    </style>
</head>
<body>

    <div id="app-container">
        <!-- Message overlay for loading and permissions -->
        <div id="message-overlay">
             <div class="spinner"></div>
             <p id="message-text">Requesting permissions...</p>
             <button id="skip-camera-btn">Continue without live camera</button>
        </div>
        
        <!-- Live camera feed -->
        <video id="camera-feed" autoplay playsinline></video>
        
        <!-- GPS information display -->
        <div id="info-overlay" style="opacity: 0;">
            <div id="map-container">
                <img id="map-thumbnail" src="https://placehold.co/140x140/333333/555555?text=Map" alt="Map Thumbnail">
            </div>
            <div id="details-container">
                <div class="detail-item">
                    <i class="bi bi-calendar-event"></i>
                    <span id="datetime">Loading date & time...</span>
                </div>
                <div class="detail-item">
                    <i class="bi bi-geo-alt-fill"></i>
                    <span id="coordinates">Loading coordinates...</span>
                </div>
                <div class="detail-item">
                     <i class="bi bi-building"></i>
                    <span id="address">Loading address...</span>
                </div>
            </div>
        </div>
        
        <!-- Capture button -->
        <button id="capture-btn" aria-label="Capture Photo" disabled></button>
    </div>
    
    <!-- Hidden canvas for processing the snapshot -->
    <canvas id="snapshot-canvas" style="display: none;"></canvas>

    <!-- Modal to display the captured photo -->
    <div id="result-modal" class="hidden">
        <img id="result-image" src="" alt="Captured Photo">
        <div class="modal-actions">
            <button id="close-modal-btn" class="modal-btn"><i class="bi bi-x-lg"></i> Close</button>
            <a id="download-btn" class="modal-btn primary" download="gps-photo.jpg"><i class="bi bi-download"></i> Download</a>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element References ---
            const video = document.getElementById('camera-feed');
            const captureBtn = document.getElementById('capture-btn');
            const canvas = document.getElementById('snapshot-canvas');
            const resultModal = document.getElementById('result-modal');
            const resultImage = document.getElementById('result-image');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const downloadBtn = document.getElementById('download-btn');
            const infoOverlay = document.getElementById('info-overlay');
            const messageOverlay = document.getElementById('message-overlay');
            const messageText = document.getElementById('message-text');
            const skipCameraBtn = document.getElementById('skip-camera-btn');

            // --- App State ---
            let locationData = null;
            let stream = null;
            let isAppInitialized = false;

            // --- Core Functions ---
            function showMessage(text) {
                messageText.textContent = text;
                messageOverlay.classList.remove('hidden');
            }
            
            function hideMessage() {
                 messageOverlay.classList.add('hidden');
            }

            function setupFallbackUI() {
                if(isAppInitialized) return; // Prevent this from running twice
                
                // Stop listening for camera
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                video.srcObject = null;
                
                captureBtn.disabled = true;

                // Initialize the rest of the app
                initializeDataServices();
                hideMessage();
            }

            function initializeDataServices() {
                if(isAppInitialized) return;
                isAppInitialized = true;
                getLocationAndInfo();
                setInterval(updateDateTime, 1000);
            }

            function getLocationAndInfo() {
                 if (!navigator.geolocation) {
                    document.getElementById('coordinates').textContent = 'Geolocation not supported';
                    document.getElementById('address').textContent = 'Geolocation not supported';
                    infoOverlay.style.opacity = '1';
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const { latitude, longitude } = position.coords;
                        locationData = { latitude, longitude };
                        
                        document.getElementById('coordinates').textContent = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;

                        try {
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                            const data = await response.json();
                            locationData.address = data.display_name || 'Address not found';
                            document.getElementById('address').textContent = locationData.address;
                        } catch (err) {
                             console.error("Address fetch error:", err);
                             locationData.address = 'Could not fetch address';
                             document.getElementById('address').textContent = locationData.address;
                        }

                        const mapUrl = `https://staticmap.openstreetmap.de/staticmap.php?center=${latitude},${longitude}&zoom=16&size=140x140&maptype=mapnik`;
                        document.getElementById('map-thumbnail').src = mapUrl;
                        infoOverlay.style.opacity = '1';
                    },
                    (err) => {
                        console.error("Geolocation Error:", err);
                        document.getElementById('coordinates').textContent = 'Location unavailable';
                        document.getElementById('address').textContent = 'Location unavailable';
                        infoOverlay.style.opacity = '1';
                    },
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                );
            }

            function updateDateTime() {
                const now = new Date();
                const options = {
                    timeZone: 'Asia/Kolkata',
                    year: 'numeric', month: 'short', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', second: '2-digit',
                    hour12: true
                };
                const istDateTime = new Intl.DateTimeFormat('en-IN', options).format(now);
                document.getElementById('datetime').textContent = istDateTime.replace(/, /g, ' | ');
            }
            
            async function capturePhoto() {
                // For this version, we will only capture if the stream is active.
                // A future version could capture a black image with data.
                if (!stream || video.paused || video.ended) {
                    alert("Camera is not active.");
                    return;
                }
                
                const context = canvas.getContext('2d');
                const videoTrack = stream.getVideoTracks()[0];
                const settings = videoTrack.getSettings();

                canvas.width = settings.width;
                canvas.height = settings.height;

                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                // --- Draw Info Overlay on Canvas ---
                const overlayData = {
                    map: document.getElementById('map-thumbnail'),
                    datetime: document.getElementById('datetime').textContent,
                    coords: document.getElementById('coordinates').textContent,
                    address: locationData?.address || 'Address not available'
                };
                
                const padding = canvas.width * 0.03;
                const overlayHeight = canvas.height * 0.20;
                const startY = canvas.height - overlayHeight;

                context.fillStyle = 'rgba(0, 0, 0, 0.75)';
                context.fillRect(0, startY, canvas.width, overlayHeight);
                
                const mapSize = overlayHeight - (padding * 2);
                try {
                    context.drawImage(overlayData.map, padding, startY + padding, mapSize, mapSize);
                } catch(e) {
                    console.error("Could not draw map image onto canvas", e);
                    context.fillStyle = '#333';
                    context.fillRect(padding, startY + padding, mapSize, mapSize);
                }

                context.fillStyle = '#FFFFFF';
                const textStartX = padding + mapSize + padding;
                const lineHeight = canvas.width * 0.025;
                let currentY = startY + padding + (lineHeight * 0.8);
                
                // Using bootstrap icon unicode characters. Requires a font that supports them on the canvas.
                const detailsFont = `500 ${lineHeight*0.9}px ${getComputedStyle(document.body).fontFamily}`;
                const timeFont = `600 ${lineHeight}px ${getComputedStyle(document.body).fontFamily}`;

                context.font = timeFont;
                context.fillText(`\u{F1EC} ${overlayData.datetime}`, textStartX, currentY); // Calendar icon
                currentY += lineHeight * 1.5;
                
                context.font = detailsFont;
                context.fillText(`\u{F3E7} ${overlayData.coords}`, textStartX, currentY); // Geo-alt-fill icon
                currentY += lineHeight * 1.5;
                
                const addressText = `\u{F1B5} ${overlayData.address}`; // Building icon
                const words = addressText.split(' ');
                let line = '';
                const maxTextWidth = canvas.width - textStartX - padding;

                for(let n = 0; n < words.length; n++) {
                    let testLine = line + words[n] + ' ';
                    let metrics = context.measureText(testLine);
                    if (metrics.width > maxTextWidth && n > 0) {
                        context.fillText(line, textStartX, currentY);
                        line = words[n] + ' ';
                        currentY += lineHeight * 1.2;
                    } else {
                        line = testLine;
                    }
                }
                context.fillText(line, textStartX, currentY);

                const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
                resultImage.src = dataUrl;
                downloadBtn.href = dataUrl;
                resultModal.classList.remove('hidden');
            }

            function init() {
                showMessage('Requesting camera & location permissions...');

                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false
                };

                navigator.mediaDevices.getUserMedia(constraints)
                    .then(mediaStream => {
                        if(isAppInitialized) return; // User already skipped
                        
                        stream = mediaStream;
                        video.srcObject = stream;
                        video.play();
                        captureBtn.disabled = false;
                        
                        initializeDataServices();
                        hideMessage();
                    })
                    .catch(err => {
                        if(isAppInitialized) return;
                        console.error("Camera access error:", err.name, err.message);
                        setupFallbackUI(); // Fallback if user explicitly denies permission
                    });

                // --- Event Listeners ---
                skipCameraBtn.addEventListener('click', setupFallbackUI);
                captureBtn.addEventListener('click', capturePhoto);
                closeModalBtn.addEventListener('click', () => resultModal.classList.add('hidden'));
            }

            init();
        });
    </script>

</body>
</html>


