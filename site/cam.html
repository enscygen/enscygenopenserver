<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>GPS Stamp Camera</title>
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #121212;
            --primary-text-color: #ffffff;
            --overlay-bg-color: rgba(0, 0, 0, 0.75);
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --secondary-text: #b0b0b0;
            --accent-color: #ffffff;
            --content-bg: #000000;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            width: 100%; height: 100%;
            overflow: hidden;
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--primary-text-color);
            -webkit-tap-highlight-color: transparent;
        }
        #app-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 15px;
            gap: 20px;
        }
        #content-box {
            position: relative;
            width: 100%;
            max-width: 500px; /* Max width for larger screens */
            background-color: var(--content-bg);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
            aspect-ratio: 16 / 9; /* Default aspect ratio */
            transition: aspect-ratio 0.4s ease;
        }
        #camera-feed, #uploaded-image-preview, #message-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
        }
        #camera-feed, #uploaded-image-preview {
            object-fit: cover;
            z-index: 1;
        }
        #uploaded-image-preview {
            object-fit: contain; /* Contain for uploaded images */
        }
        #message-overlay {
            color: white;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            text-align: center; padding: 20px;
            font-size: 14px; z-index: 100;
            background-color: rgba(0,0,0,0.8);
            transition: opacity 0.3s ease;
        }
        #message-overlay.hidden { opacity: 0; pointer-events: none; }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%;
            border-top: 4px solid #fff; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #skip-camera-btn {
            background-color: transparent; color: var(--secondary-text);
            border: 1px solid var(--secondary-text); padding: 8px 16px;
            border-radius: 20px; font-size: 13px; cursor: pointer;
            font-weight: 500; margin-top: 20px;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        #skip-camera-btn:hover { background-color: var(--secondary-text); color: var(--bg-color); }
        #info-overlay {
            position: absolute; bottom: 0; left: 0;
            width: 100%; padding: 10px 12px;
            background: var(--overlay-bg-color);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            color: var(--primary-text-color);
            display: flex; align-items: center; gap: 12px;
            transition: opacity 0.3s ease, background-color 0.3s ease, color 0.3s ease;
            font-family: var(--font-family);
            z-index: 10; /* Ensures it's above the image/video */
        }
        #map-container {
            flex-shrink: 0; width: 70px; height: 70px;
            border-radius: 8px; overflow: hidden; background-color: #333;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        #map-thumbnail { width: 100%; height: 100%; object-fit: cover; }
        #details-container { display: flex; flex-direction: column; gap: 6px; font-size: 11px; font-weight: 500; }
        .detail-item { display: flex; align-items: center; gap: 6px; color: var(--secondary-text); }
        .detail-item i { font-size: 12px; color: var(--primary-text-color); }
        .detail-item span { color: var(--primary-text-color); }
        #address {
           white-space: normal; display: -webkit-box;
           -webkit-line-clamp: 2; -webkit-box-orient: vertical;  
           overflow: hidden;
        }
        #actions-container {
            position: static;
            width: 100%;
            max-width: 500px;
            display: flex; justify-content: center; align-items: center;
            gap: 40px; z-index: 10;
        }
        #capture-btn {
            position: static; width: 60px; height: 60px;
            border-radius: 50%; background-color: var(--accent-color);
            border: 4px solid var(--bg-color); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            transition: transform 0.1s ease-out, background-color 0.3s ease;
        }
        #capture-btn:active { transform: scale(0.95); }
        #capture-btn:disabled { background-color: #555; cursor: not-allowed; box-shadow: none; }
        .action-btn {
            width: 44px; height: 44px;
            border-radius: 50%; background-color: rgba(68, 68, 68, 0.7);
            border: none; color: white; font-size: 20px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        #settings-modal {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); z-index: 200;
            display: flex; justify-content: center; align-items: center;
            opacity: 1; transition: opacity 0.3s ease;
        }
        #settings-modal.hidden { opacity: 0; pointer-events: none; }
        .modal-content {
            background-color: #2c2c2e; color: white;
            border-radius: 12px; width: 90%; max-width: 350px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.5);
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 16px; border-bottom: 1px solid #444;
        }
        .modal-header h2 { font-size: 16px; font-weight: 600; }
        #close-settings-btn { background: none; border: none; color: #aaa; font-size: 24px; cursor: pointer; }
        .modal-body { padding: 16px; display: flex; flex-direction: column; gap: 20px; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        .setting-item input[type="range"] { width: 40%; }
        .setting-item input[type="color"] { border: none; background: none; width: 30px; height: 30px; padding: 0; }
        .setting-item select {
            background-color: #555; color: white;
            border: 1px solid #777; border-radius: 4px; padding: 4px 8px; font-size: 13px;
        }
    </style>
</head>
<body>
    <!-- Main container for the app's visual elements -->
    <div id="app-container">
        <!-- The new content box for camera feed and overlays -->
        <div id="content-box">
            <div id="message-overlay">
                <div class="spinner"></div>
                <p id="message-text">Requesting permissions...</p>
                <button id="skip-camera-btn">Continue without camera</button>
            </div>
            <video id="camera-feed" autoplay playsinline></video>
            <img id="uploaded-image-preview" style="display: none;" />
            <div id="info-overlay" style="opacity: 0;">
                <div id="map-container">
                    <img id="map-thumbnail" src="https://placehold.co/140x140/333333/555555?text=Map" alt="Map Thumbnail">
                </div>
                <div id="details-container">
                    <div class="detail-item"><i class="bi bi-calendar-event"></i><span id="datetime">...</span></div>
                    <div class="detail-item"><i class="bi bi-geo-alt-fill"></i><span id="coordinates">...</span></div>
                    <div class="detail-item"><i class="bi bi-building"></i><span id="address">...</span></div>
                </div>
            </div>
        </div>

        <!-- Action buttons are now outside the content box -->
        <div id="actions-container">
            <button id="gallery-btn" class="action-btn" aria-label="Open Gallery"><i class="bi bi-image"></i></button>
            <button id="capture-btn" aria-label="Stamp & Save Photo" disabled></button>
            <button id="settings-btn" class="action-btn" aria-label="Settings"><i class="bi bi-gear-fill"></i></button>
        </div>
        
        <input type="file" id="gallery-input" accept="image/*" style="display: none;">
    </div>

    <!-- Hidden elements remain outside the main container -->
    <canvas id="snapshot-canvas" style="display: none;"></canvas>
    <a id="download-btn" style="display: none;"></a>

    <!-- Settings Modal: Add the new Aspect Ratio selector -->
    <div id="settings-modal" class="hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <button id="close-settings-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="setting-item">
                    <label for="aspect-ratio-select">Image Ratio</label>
                    <select id="aspect-ratio-select">
                        <option value="4 / 5">4:5 (Portrait)</option>
                        <option value="1 / 1">1:1 (Square)</option>
                        <option value="4 / 3">4:3 (Classic)</option>
                        <option value="16 / 9" selected>16:9 (Widescreen)</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label for="opacity-slider">Overlay Opacity</label>
                    <input type="range" id="opacity-slider" min="0.1" max="1" step="0.05" value="0.75">
                </div>
                <div class="setting-item">
                    <label for="font-color-picker">Font Color</label>
                    <input type="color" id="font-color-picker" value="#FFFFFF">
                </div>
                 <div class="setting-item">
                    <label for="font-family-select">Font Family</label>
                    <select id="font-family-select">
                        <option value="'Inter', sans-serif">Inter (Default)</option>
                        <option value="'Times New Roman', serif">Times New Roman</option>
                        <option value="'Courier New', monospace">Courier New</option>
                        <option value="'Arial', sans-serif">Arial</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Element References ---
            const getEl = (id) => document.getElementById(id);
            const contentBox = getEl('content-box');
            const video = getEl('camera-feed'), canvas = getEl('snapshot-canvas'), downloadBtn = getEl('download-btn'),
                  infoOverlay = getEl('info-overlay'), messageOverlay = getEl('message-overlay'),
                  messageText = getEl('message-text'), skipCameraBtn = getEl('skip-camera-btn'),
                  captureBtn = getEl('capture-btn'), galleryBtn = getEl('gallery-btn'),
                  settingsBtn = getEl('settings-btn'), galleryInput = getEl('gallery-input'),
                  uploadedImagePreview = getEl('uploaded-image-preview'), settingsModal = getEl('settings-modal'),
                  closeSettingsBtn = getEl('close-settings-btn'), opacitySlider = getEl('opacity-slider'),
                  fontColorPicker = getEl('font-color-picker'), fontFamilySelect = getEl('font-family-select'),
                  aspectRatioSelect = getEl('aspect-ratio-select');

            // --- App State ---
            let locationData = null, stream = null, isAppInitialized = false, currentMode = 'camera';
            let currentSettings = {
                opacity: 0.75,
                fontColor: '#FFFFFF',
                fontFamily: "'Inter', sans-serif",
                aspectRatio: "16 / 9"
            };
            
            // --- Core Functions ---
            function setupFallbackUI() {
                if (isAppInitialized) return;
                if (stream) stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                video.style.display = 'none';
                captureBtn.disabled = true;
                galleryBtn.disabled = false; // Keep gallery enabled
                initializeDataServices();
                hideMessage();
            }

            function initializeDataServices() {
                if (isAppInitialized) return;
                isAppInitialized = true;
                getLocationAndInfo();
                setInterval(updateDateTime, 1000);
            }

            function getLocationAndInfo() {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const { latitude, longitude } = position.coords;
                        locationData = { latitude, longitude };
                        getEl('coordinates').textContent = `${latitude.toFixed(8)}, ${longitude.toFixed(8)}`;
                        
                        try {
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                            const data = await response.json();
                            locationData.address = data.display_name || 'Address not found';
                            getEl('address').textContent = locationData.address;
                        } catch (err) {
                             locationData.address = 'Could not fetch address';
                             getEl('address').textContent = locationData.address;
                        }
                        
                        const mapUrl = `https://staticmap.org/api/v1/map?center=${longitude},${latitude}&zoom=16&size=140x140&marker=lonlat:${longitude},${latitude};color:%23ff0000;size:small`;
                        getEl('map-thumbnail').src = mapUrl;
                        infoOverlay.style.opacity = '1';
                    },
                    (err) => {
                        console.error("Geolocation Error:", err);
                        getEl('coordinates').textContent = 'Location unavailable';
                        getEl('address').textContent = 'Location unavailable';
                        infoOverlay.style.opacity = '1';
                    },
                    { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
                );
            }

            function updateDateTime() {
                const now = new Date();
                const options = {
                    timeZone: 'Asia/Kolkata', year: 'numeric', month: 'short', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true
                };
                getEl('datetime').textContent = new Intl.DateTimeFormat('en-IN', options).format(now);
            }

            async function stampAndSavePhoto() {
                const sourceElement = currentMode === 'camera' ? video : uploadedImagePreview;
                const sourceWidth = currentMode === 'camera' ? sourceElement.videoWidth : sourceElement.naturalWidth;
                const sourceHeight = currentMode === 'camera' ? sourceElement.videoHeight : sourceElement.naturalHeight;

                if (!sourceWidth || !sourceHeight) return alert("Source image is not ready.");

                canvas.width = sourceWidth;
                canvas.height = sourceHeight;
                const context = canvas.getContext('2d');
                context.drawImage(sourceElement, 0, 0, canvas.width, canvas.height);

                const overlayData = {
                    map: getEl('map-thumbnail'),
                    datetime: getEl('datetime').textContent,
                    coords: getEl('coordinates').textContent,
                    address: locationData?.address || 'Address not available'
                };
                
                const padding = canvas.width * 0.03;
                const overlayHeight = canvas.height * 0.20;
                const startY = canvas.height - overlayHeight;
                context.fillStyle = `rgba(0, 0, 0, ${currentSettings.opacity})`;
                context.fillRect(0, startY, canvas.width, overlayHeight);
                
                const mapSize = overlayHeight - (padding * 2);
                try { context.drawImage(overlayData.map, padding, startY + padding, mapSize, mapSize); } 
                catch(e) { console.error("Could not draw map.", e); }

                context.fillStyle = currentSettings.fontColor;
                const textStartX = padding + mapSize + padding;
                const lineHeight = canvas.width * 0.025;
                let currentY = startY + padding + (lineHeight * 0.8);
                
                const setFont = (weight, size) => `${weight} ${size}px ${currentSettings.fontFamily}`;
                
                context.font = setFont(600, lineHeight);
                context.fillText(`\u{F1EC} ${overlayData.datetime}`, textStartX, currentY);
                currentY += lineHeight * 1.5;
                
                context.font = setFont(500, lineHeight * 0.9);
                context.fillText(`\u{F3E7} ${overlayData.coords}`, textStartX, currentY);
                currentY += lineHeight * 1.5;
                
                const addressText = `\u{F1B5} ${overlayData.address}`;
                const words = addressText.split(' ');
                let line = '';
                const maxTextWidth = canvas.width - textStartX - padding;
                for (let n = 0; n < words.length; n++) {
                    let testLine = line + words[n] + ' ';
                    if (context.measureText(testLine).width > maxTextWidth && n > 0) {
                        context.fillText(line, textStartX, currentY);
                        line = words[n] + ' ';
                        currentY += lineHeight * 1.2;
                    } else { line = testLine; }
                }
                context.fillText(line, textStartX, currentY);

                const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                downloadBtn.download = `gps-photo-${timestamp}.jpg`;
                downloadBtn.href = dataUrl;
                downloadBtn.click();
            }

            function handleFileUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        uploadedImagePreview.src = e.target.result;
                        uploadedImagePreview.style.display = 'block';
                        video.style.display = 'none';
                        currentMode = 'gallery';
                        captureBtn.disabled = false;
                        if (stream) stream.getTracks().forEach(track => track.stop());
                        video.srcObject = null;
                    };
                    reader.readAsDataURL(file);
                }
            }

            function applySettings() {
                currentSettings.opacity = opacitySlider.value;
                currentSettings.fontColor = fontColorPicker.value;
                currentSettings.fontFamily = fontFamilySelect.value;
                currentSettings.aspectRatio = aspectRatioSelect.value;
                
                const root = document.documentElement;
                root.style.setProperty('--overlay-bg-color', `rgba(0, 0, 0, ${currentSettings.opacity})`);
                root.style.setProperty('--primary-text-color', currentSettings.fontColor);
                root.style.setProperty('--font-family', currentSettings.fontFamily);
                contentBox.style.aspectRatio = currentSettings.aspectRatio;
            }

            function hideMessage() { messageOverlay.classList.add('hidden'); }

            function init() {
                messageText.textContent = 'Requesting camera & location permissions...';
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 }}, audio: false })
                    .then(mediaStream => {
                        if (isAppInitialized) return;
                        stream = mediaStream;
                        video.srcObject = stream;
                        video.play();
                        captureBtn.disabled = false;
                        initializeDataServices();
                        hideMessage();
                    })
                    .catch(err => {
                        if (isAppInitialized) return;
                        console.error("Camera access error:", err);
                    });

                skipCameraBtn.addEventListener('click', setupFallbackUI);
                captureBtn.addEventListener('click', stampAndSavePhoto);
                galleryBtn.addEventListener('click', () => galleryInput.click());
                galleryInput.addEventListener('change', handleFileUpload);
                settingsBtn.addEventListener('click', () => settingsModal.classList.remove('hidden'));
                closeSettingsBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));
                
                opacitySlider.addEventListener('input', applySettings);
                fontColorPicker.addEventListener('input', applySettings);
                fontFamilySelect.addEventListener('change', applySettings);
                aspectRatioSelect.addEventListener('change', applySettings);
            }

            init();
        });
    </script>
</body>
</html>


