<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gel Size Estimator — Standard Curve</title>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<style>
  :root{
    --bg:#0f1720;
    --panel:#0b1220;
    --muted:#94a3b8;
    --accent:#6ee7b7;
    --glass: rgba(255,255,255,0.03);
    --card: #071021;
    --radius:10px;
    --small:12px;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
    color-scheme: dark;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#02101a 120%);font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; color:#e6eef6; -webkit-font-smoothing:antialiased}
  .app {
    max-width:980px;
    margin:28px auto;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:var(--radius);
    box-shadow: 0 10px 30px rgba(2,8,23,0.6);
    overflow:hidden;
    display:grid;
    grid-template-columns: 420px 1fr;
    gap:0;
    min-height:520px;
  }

  /* title bar */
  header.title {
    grid-column:1/-1;
    display:flex;
    align-items:center;
    gap:12px;
    padding:10px 14px;
    background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
    border-bottom: 1px solid rgba(255,255,255,0.03);
  }
  .title .brand {
    display:flex; align-items:center; gap:10px; font-weight:600; font-size:13px;
  }
  .title .brand .icon {
    width:30px; height:30px; background:linear-gradient(135deg,var(--accent), #60a5fa); border-radius:7px; display:grid; place-items:center; color:#012018; font-weight:700;
    box-shadow: 0 3px 12px rgba(59,130,246,0.06), inset 0 -6px 24px rgba(0,0,0,0.1);
  }
  .title .meta {margin-left:auto; font-size:12px; color:var(--muted); display:flex; gap:10px; align-items:center}
  .title .meta .hint {display:flex; gap:8px; align-items:center; color:var(--muted)}
  .title .meta .btn {
    background:transparent; border:1px solid rgba(255,255,255,0.03); color:var(--muted); padding:6px 8px; border-radius:8px; font-size:12px; cursor:pointer;
  }

  /* left column - controls */
  .controls {
    padding:14px;
    border-right:1px solid rgba(255,255,255,0.02);
    background: linear-gradient(180deg, rgba(255,255,255,0.006), rgba(255,255,255,0.003));
    min-width:320px;
  }
  .section-title {
    font-size:12px; color:var(--muted); display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;
  }

  label {display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
  .small {font-size:var(--small); color:var(--muted)}
  .row {display:flex; gap:8px; align-items:center}
  input[type="number"], input[type="text"]{
    width:100%; padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background:var(--glass); color:inherit; font-size:13px;
  }
  button, .btn {
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    color:var(--accent); border:1px solid rgba(255,255,255,0.03); padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px;
  }
  button.ghost { background:transparent; border:1px dashed rgba(255,255,255,0.03); color:var(--muted); font-weight:500 }
  .muted { color:var(--muted); font-size:12px }

  .table {
    margin-top:8px;
    background:transparent;
    border-radius:8px;
    border:1px solid rgba(255,255,255,0.02);
    padding:8px;
    max-height:220px;
    overflow:auto;
    font-size:13px;
  }
  .table .row-item { display:grid; grid-template-columns: 1fr 78px 36px; gap:8px; align-items:center; padding:6px; border-radius:6px; }
  .table .row-item header {font-size:12px; color:var(--muted)}
  .table .row-item input {padding:6px; font-size:13px}
  .table .row-item .rm {background:transparent;border:0;color:var(--muted); cursor:pointer}

  .actions {display:flex; gap:8px; margin-top:10px}

  /* right column - plot + results */
  .main {
    padding:14px;
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .canvas-wrap {
    background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
    border-radius:8px;
    padding:10px;
    border:1px solid rgba(255,255,255,0.02);
  }
  canvas {width:100%; height:260px; display:block; border-radius:6px; background:linear-gradient(180deg, rgba(0,0,0,0.02), transparent)}
  .results {
    display:flex; gap:12px; align-items:center; justify-content:space-between;
  }
  .result-card {
    background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
    border-radius:8px; padding:10px; min-width:160px; border:1px solid rgba(255,255,255,0.02);
  }
  .result-card h3 {margin:0; font-size:15px}
  .result-card p {margin:6px 0 0 0; color:var(--muted); font-size:13px}

  .log {font-family:var(--mono); font-size:12px; color:var(--muted); background:transparent; padding:6px; border-radius:6px; border:1px dashed rgba(255,255,255,0.02)}
  footer.help {font-size:12px; color:var(--muted); display:flex; gap:8px; align-items:center}

  /* compact */
  .compact {font-size:13px}
  .controls .small-input {display:flex; gap:8px}
  .controls .small-input input {padding:6px; font-size:13px}

  /* responsive */
  @media (max-width:880px){
    .app { grid-template-columns: 1fr; margin:8px; min-height:640px;}
    .controls {order:2}
    .main {order:1}
    canvas{height:220px}
  }
</style>
</head>
<body>
  <div class="app" role="application" aria-label="Gel sizing standard curve">
    <header class="title">
      <div class="brand">
        <div class="icon">G</div>
        <div>
          <div style="font-size:13px">Gel Size Estimator</div>
          <div style="font-size:11px;color:var(--muted)">Standard-curve sizing — log10(bp) vs distance</div>
        </div>
      </div>

      <div class="meta">
        <div class="hint"><i class="bi bi-rulers" style="font-size:14px;color:var(--muted)"></i><span class="small">Measure from top of well</span></div>
        <button id="loadExample" class="btn" title="Load example ladder & sample"><i class="bi bi-lightning-fill"></i>&nbsp;Example</button>
      </div>
    </header>

    <aside class="controls compact" aria-label="Controls">
      <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:6px">
        <div class="section-title">Ladder bands</div>
        <div class="small muted">Sizes in bp, distances in mm or px</div>
      </div>

      <div class="table" id="ladderList" aria-live="polite">
        <!-- dynamic ladder rows here -->
      </div>

      <div style="display:flex; gap:8px; margin-top:8px;">
        <input id="ladderSize" type="number" placeholder="size (bp)" min="1" step="1" />
        <input id="ladderDist" type="number" placeholder="distance" min="0" step="0.1" />
        <button id="addLadder" class="btn" title="Add ladder band"><i class="bi bi-plus-lg"></i></button>
      </div>

      <div class="section-title" style="margin-top:14px">Sample distances</div>
      <div class="table" id="sampleList"></div>

      <div style="display:flex; gap:8px; margin-top:8px;">
        <input id="sampleName" type="text" placeholder="Sample name (optional)" />
        <input id="sampleDist" type="number" placeholder="distance" min="0" step="0.1" />
        <button id="addSample" class="btn" title="Add sample"><i class="bi bi-plus-square"></i></button>
      </div>

      <div class="actions">
        <button id="compute" class="btn"><i class="bi bi-calculator"></i> Compute</button>
        <button id="clearAll" class="ghost"><i class="bi bi-trash"></i> Clear</button>
      </div>

      <div style="margin-top:10px">
        <div class="small muted">Tips:</div>
        <ul style="padding-left:18px;margin:6px 0 0 0;color:var(--muted);font-size:12px">
          <li>Use ladder bands spanning your expected range (no extrapolation).</li>
          <li>Measure from same origin (well top) and units for ladder and samples.</li>
        </ul>
      </div>
    </aside>

    <main class="main" role="main">
      <div class="canvas-wrap">
        <canvas id="plot" width="640" height="340" aria-label="Standard curve plot"></canvas>
      </div>

      <div class="results">
        <div class="result-card" id="fitCard">
          <h3>Fit</h3>
          <p id="fitEq" class="muted">—</p>
          <p id="r2" class="muted" style="margin-top:6px">R²: —</p>
        </div>

        <div class="result-card">
          <h3>Samples</h3>
          <div id="resultsList" class="log" style="min-width:220px; max-width:360px; white-space:pre-wrap">No results yet</div>
        </div>

        <div style="min-width:220px">
          <div class="small muted">Export / copy</div>
          <div style="display:flex; gap:8px; margin-top:8px">
            <button id="copyRes" class="btn"><i class="bi bi-clipboard"></i> Copy</button>
            <button id="downloadCsv" class="btn"><i class="bi bi-file-earmark-arrow-down"></i> CSV</button>
          </div>
        </div>
      </div>

      <footer class="help">
        <div class="muted">Algorithm: linear least-squares on log10(bp) vs distance → interpolate → 10^pred</div>
      </footer>
    </main>
  </div>

<script>
/*
  Gel Size Estimator
  - Ladder entries: size (bp), distance (mm or px)
  - Fit: y = log10(bp) vs x = distance => linear least squares
  - Predict: for sample distance d, y_pred = a*d + b ; bp = 10^y_pred
  - Shows R^2 and simple scatter+fit line on canvas (no external libs)
*/

// --- state ---
const state = {
  ladder: [], // {size: number, dist: number}
  samples: [] // {name, dist, bp (after compute)}
};

// --- helpers ---
const el = id => document.getElementById(id);
const fmt = n => (Number.isFinite(n) ? (Math.round(n*100)/100).toString() : '—');

function createLadderRow(item, idx){
  const row = document.createElement('div');
  row.className = 'row-item';
  const left = document.createElement('div');
  left.innerHTML = `<header>${item.size} bp</header><div class="small muted">distance: ${item.dist}</div>`;
  const input = document.createElement('input');
  input.type = 'number';
  input.value = item.dist;
  input.step = '0.1';
  input.addEventListener('change', (e)=>{
    state.ladder[idx].dist = parseFloat(e.target.value) || 0;
    render();
  });
  const rm = document.createElement('button');
  rm.className = 'rm';
  rm.innerHTML = '<i class="bi bi-x-lg"></i>';
  rm.title = 'Remove';
  rm.addEventListener('click', ()=>{ state.ladder.splice(idx,1); render(); });

  row.appendChild(left);
  const wrapper = document.createElement('div'); wrapper.style.display='flex'; wrapper.style.justifyContent='center'; wrapper.style.alignItems='center';
  wrapper.appendChild(input);
  row.appendChild(wrapper);
  row.appendChild(rm);
  return row;
}

function createSampleRow(item, idx){
  const row = document.createElement('div');
  row.className = 'row-item';
  const left = document.createElement('div');
  left.innerHTML = `<header>${item.name || 'Sample '+(idx+1)}</header><div class="small muted">dist: ${item.dist}</div>`;
  const bpSpan = document.createElement('div');
  bpSpan.style.textAlign='center';
  bpSpan.innerHTML = item.bp ? `<div style="font-weight:700">${Math.round(item.bp)} bp</div><div class="small muted">${fmt(item.bp)}</div>` : '<div class="small muted">—</div>';
  const rm = document.createElement('button');
  rm.className = 'rm';
  rm.innerHTML = '<i class="bi bi-x-lg"></i>';
  rm.title = 'Remove';
  rm.addEventListener('click', ()=>{ state.samples.splice(idx,1); render(); });

  row.appendChild(left);
  row.appendChild(bpSpan);
  row.appendChild(rm);
  return row;
}

// render lists
function render(){
  const ladderList = el('ladderList'); ladderList.innerHTML='';
  state.ladder.forEach((it,i)=> ladderList.appendChild(createLadderRow(it,i)));

  const sampleList = el('sampleList'); sampleList.innerHTML='';
  state.samples.forEach((it,i)=> sampleList.appendChild(createSampleRow(it,i)));

  drawPlot();
  showResults();
}

// numeric helpers
function log10(x){ return Math.log(x)/Math.LN10; }
function pow10(x){ return Math.pow(10,x); }

// linear least-squares fit y = a*x + b
function linearFit(xs, ys){
  const n = xs.length;
  if(n < 2) return null;
  let sx=0, sy=0, sxy=0, sx2=0, sy2=0;
  for(let i=0;i<n;i++){
    const x = xs[i], y = ys[i];
    sx += x; sy += y; sxy += x*y; sx2 += x*x; sy2 += y*y;
  }
  const denom = n*sx2 - sx*sx;
  if(Math.abs(denom) < 1e-12) return null;
  const a = (n*sxy - sx*sy)/denom;
  const b = (sy - a*sx)/n;
  const // r^2
    ss_tot = sy2 - (sy*sy)/n,
    ss_res = ss_tot - a*(sxy - (sx*sy)/n); // derived from relationships
  const r2 = ss_tot === 0 ? 1 : 1 - ss_res/ss_tot;
  return {a,b,r2};
}

// compute
function compute(){
  if(state.ladder.length < 2){
    alert('Please add at least two ladder bands that span the range of interest.');
    return;
  }
  // prepare arrays
  const xs = state.ladder.map(x=> Number(x.dist));
  const ys = state.ladder.map(x=> log10(Number(x.size)));
  const fit = linearFit(xs, ys);
  if(!fit){
    alert('Fit failed (check ladder distances).');
    return;
  }
  // compute sample predictions
  state.samples = state.samples.map(s=>{
    const d = Number(s.dist);
    const ypred = fit.a*d + fit.b;
    const bp = pow10(ypred);
    return {...s, bp};
  });
  render();
  // update fit card
  el('fitEq').textContent = `log10(bp) = ${fit.a.toFixed(6)} × distance + ${fit.b.toFixed(6)}`;
  el('r2').textContent = `R²: ${Math.max(0,Math.min(1,fit.r2)).toFixed(4)}`;
}

// show results text
function showResults(){
  const r = el('resultsList');
  if(state.samples.length === 0){ r.textContent = 'No results yet'; return; }
  let out = '';
  state.samples.forEach(s=>{
    out += `${s.name || 'Sample'}\tDistance: ${s.dist}\tSize: ${s.bp ? Math.round(s.bp)+' bp' : '—'}\n`;
  });
  r.textContent = out.trim();
}

// simple canvas plot: scatter ladder (distance vs log10(bp)) and fit line
function drawPlot(){
  const canvas = el('plot');
  const ctx = canvas.getContext('2d');
  // clear
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // draw background grid
  ctx.fillStyle = 'rgba(255,255,255,0.01)'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle = 'rgba(255,255,255,0.03)';
  ctx.lineWidth = 1;
  // padding
  const pad = {l:52, r:18, t:18, b:40};
  const w = canvas.width - pad.l - pad.r;
  const h = canvas.height - pad.t - pad.b;

  // data
  if(state.ladder.length === 0){
    // draw placeholder text
    ctx.fillStyle = 'rgba(255,255,255,0.06)'; ctx.font = '14px '+getComputedStyle(document.body).fontFamily;
    ctx.fillText('Add ladder bands to see standard curve', pad.l+8, pad.t + h/2);
    return;
  }
  const xs = state.ladder.map(x=>Number(x.dist));
  const ys = state.ladder.map(x=>log10(Number(x.size)));
  const minX = Math.min(...xs), maxX = Math.max(...xs);
  const minY = Math.min(...ys), maxY = Math.max(...ys);
  const marginX = (maxX-minX)*0.12 || 1;
  const marginY = (maxY-minY)*0.12 || 0.1;
  const x0 = minX - marginX, x1 = maxX + marginX;
  const y0 = minY - marginY, y1 = maxY + marginY;

  function sx(x){ return pad.l + ((x - x0)/(x1 - x0)) * w; }
  function sy(y){ return pad.t + (1 - (y - y0)/(y1 - y0)) * h; }

  // axes
  ctx.strokeStyle = 'rgba(255,255,255,0.06)'; ctx.lineWidth = 1.0;
  ctx.beginPath(); ctx.moveTo(pad.l, pad.t); ctx.lineTo(pad.l, pad.t+h); ctx.lineTo(pad.l+w, pad.t+h); ctx.stroke();

  // ticks
  ctx.fillStyle = 'rgba(255,255,255,0.06)'; ctx.font='11px '+getComputedStyle(document.body).fontFamily;
  const xticks = 5;
  for(let i=0;i<=xticks;i++){
    const vx = x0 + (x1-x0)*i/xticks;
    const px = sx(vx);
    ctx.beginPath(); ctx.moveTo(px, pad.t+h); ctx.lineTo(px, pad.t+h+6); ctx.stroke();
    ctx.fillText(vx.toFixed(1), px-14, pad.t+h+18);
  }
  const yticks = 5;
  for(let i=0;i<=yticks;i++){
    const vy = y0 + (y1-y0)*i/yticks;
    const py = sy(vy);
    ctx.beginPath(); ctx.moveTo(pad.l-6, py); ctx.lineTo(pad.l, py); ctx.stroke();
    ctx.fillText(vy.toFixed(2), 8, py+4);
  }

  // draw ladder points
  for(let i=0;i<xs.length;i++){
    const px = sx(xs[i]), py = sy(ys[i]);
    ctx.beginPath();
    ctx.fillStyle = 'rgba(110,231,183,0.95)';
    ctx.arc(px, py, 5, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle = 'rgba(255,255,255,0.7)'; ctx.font = '11px '+getComputedStyle(document.body).fontFamily;
    ctx.fillText(`${Math.round(state.ladder[i].size)} bp`, px+8, py+4);
  }

  // fit line
  const fit = linearFit(xs, ys);
  if(fit){
    // compute line endpoints within x0..x1
    const yA = fit.a * x0 + fit.b;
    const yB = fit.a * x1 + fit.b;
    ctx.beginPath(); ctx.lineWidth = 2;
    ctx.strokeStyle = 'rgba(96,165,250,0.95)';
    ctx.moveTo(sx(x0), sy(yA));
    ctx.lineTo(sx(x1), sy(yB));
    ctx.stroke();

    // also draw sample points (if computed)
    state.samples.forEach(s=>{
      const d = Number(s.dist);
      const ypred = fit.a*d + fit.b;
      const px = sx(d), py = sy(ypred);
      ctx.beginPath();
      ctx.fillStyle = 'rgba(255,193,7,0.95)';
      ctx.rect(px-4, py-4, 8, 8);
      ctx.fill();
      ctx.fillStyle = 'rgba(255,255,255,0.85)'; ctx.font='12px '+getComputedStyle(document.body).fontFamily;
      ctx.fillText(s.name || '', px+8, py+4);
    });
  }
}

// UI events
el('addLadder').addEventListener('click', ()=>{
  const s = Number(el('ladderSize').value);
  const d = Number(el('ladderDist').value);
  if(!s || !d){ alert('Enter ladder size (bp) and distance.'); return; }
  state.ladder.push({size: Math.round(s), dist: Number(d)});
  el('ladderSize').value=''; el('ladderDist').value='';
  // sort ladder by size ascending (optional)
  state.ladder.sort((a,b)=> a.size - b.size);
  render();
});

el('addSample').addEventListener('click', ()=>{
  const name = el('sampleName').value.trim();
  const d = Number(el('sampleDist').value);
  if(!d){ alert('Enter sample distance.'); return; }
  state.samples.push({name: name || '', dist: Number(d)});
  el('sampleName').value=''; el('sampleDist').value='';
  render();
});

el('compute').addEventListener('click', compute);

el('clearAll').addEventListener('click', ()=>{
  if(!confirm('Clear all ladder bands and samples?')) return;
  state.ladder = []; state.samples = []; el('fitEq').textContent='—'; el('r2').textContent='R²: —'; render();
});

el('copyRes').addEventListener('click', ()=>{
  let out = 'Sample\tDistance\tSize(bp)\\n';
  state.samples.forEach(s => out += `${s.name || 'Sample'}\t${s.dist}\t${s.bp?Math.round(s.bp):'—'}\\n`);
  navigator.clipboard?.writeText(out).then(()=> alert('Results copied to clipboard'), ()=> alert('Copy failed'));
});

el('downloadCsv').addEventListener('click', ()=>{
  let csv = 'Sample,Distance,Size(bp)\\n';
  state.samples.forEach(s=> csv += `"${s.name.replace(/"/g,'""')}",${s.dist},${s.bp?Math.round(s.bp):''}\\n`);
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'gel-sizing-results.csv'; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});

// example loader
el('loadExample').addEventListener('click', ()=>{
  state.ladder = [
    {size:100, dist:52},
    {size:200, dist:47},
    {size:300, dist:43},
    {size:500, dist:36},
    {size:700, dist:30},
    {size:1000, dist:24}
  ];
  state.samples = [{name:'Unknown A', dist:39}];
  el('fitEq').textContent='—'; el('r2').textContent='R²: —';
  render();
  compute();
});

// initial render
render();
</script>
</body>
</html>