<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protocol Runner</title>
    <style>
        /* General Body Styling */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        /* Main App Container */
        .app-container {
            width: 100%;
            max-width: 800px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        /* Header Styling */
        header {
            background-color: #4a90e2;
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 1.5em;
            font-weight: 600;
        }

        /* Main Content Area */
        main {
            padding: 20px;
        }

        /* Section Styling */
        .section {
            margin-bottom: 25px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
        }

        .section-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #4a90e2;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }
        
        /* Protocol Steps List (Setup View) */
        #protocol-steps {
            list-style: none;
            padding: 0;
            min-height: 60px;
            border: 2px dashed #d0d0d0;
            border-radius: 8px;
            padding: 10px;
            background-color: #fafafa;
        }

        .step-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: grab;
            transition: background-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: relative;
            border-left: 5px solid #ccc; /* Default border for non-grouped steps */
        }
        
        .step-item:last-child { margin-bottom: 0; }
        .step-item.dragging { opacity: 0.5; background: #e9f2ff; }
        .step-item .drag-handle { margin-right: 15px; color: #aaa; cursor: grab; }
        .step-item .step-content { flex-grow: 1; }
        .step-name { font-weight: 600; font-size: 1.1em; }
        .step-details { font-size: 0.9em; color: #666; margin-top: 5px; }
        .step-details span { margin-right: 15px; }
        .step-description { font-size: 0.9em; color: #888; margin-top: 5px; font-style: italic; }
        .step-actions button { margin-left: 5px; background: none; border: none; cursor: pointer; padding: 5px; border-radius: 50%; width: 30px; height: 30px; display: inline-flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
        .step-actions button:hover { background-color: #f0f0f0; }

        /* Buttons Styling */
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: 500; transition: background-color 0.2s, transform 0.1s; margin-right: 10px; }
        .btn:active { transform: translateY(1px); }
        .btn-primary { background-color: #4a90e2; color: white; }
        .btn-primary:hover { background-color: #357abd; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-success:hover { background-color: #218838; }
        .btn-warning { background-color: #ffc107; color: #212529; }
        .btn-warning:hover { background-color: #e0a800; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-info { background-color: #17a2b8; color: white; }
        .btn-info:hover { background-color: #138496; }
        .btn-icon { background-color: #4a90e2; color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 1.5em; display: inline-flex; align-items: center; justify-content: center; padding: 0; }
        .btn-icon:hover { background-color: #357abd; }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 30px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-content h2 { margin-top: 0; color: #4a90e2; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .form-group textarea { resize: vertical; min-height: 80px; }
        
        /* Cycle Modal styles */
        #existing-cycles-list { list-style: none; padding: 0; margin-top: 15px; }
        .existing-cycle-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-radius: 4px; background-color: #f8f9fa; margin-bottom: 5px; }
        .existing-cycle-item button { background: #dc3545; color: white; border: none; border-radius: 4px; padding: 2px 8px; font-size: 0.8em; }


        /* Protocol Runner View */
        #runner-view { text-align: center; }
        #runner-view .info-display { background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        #runner-view h3 { margin-top: 0; font-size: 1.5em; color: #333; }
        #runner-view #current-step-name { font-weight: 600; color: #4a90e2; }
        #runner-view #step-countdown { font-size: 3em; font-weight: 700; color: #28a745; margin: 10px 0; }
        #runner-view #total-time-remaining-container { margin-top: -10px; margin-bottom: 10px; color: #6c757d; }
        #runner-view #next-step-info { color: #6c757d; font-style: italic; }
        .progress-bar-container { width: 100%; background-color: #e9ecef; border-radius: 8px; overflow: hidden; margin-bottom: 10px; }
        .progress-bar { height: 20px; width: 0%; background-color: #4a90e2; text-align: center; line-height: 20px; color: white; font-size: 0.8em; transition: width 0.5s ease-in-out; }
        #overall-progress-bar { background-color: #28a745; }

        /* Runner Steps List Styling */
        #runner-steps-list-container { margin-top: 20px; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; }
        #runner-steps-list { list-style: none; padding: 10px; margin: 0; transition: all 0.3s ease; }
        .runner-step-item { display: flex; align-items: center; background: #fff; border: 1px solid #eee; border-radius: 8px; position: relative; overflow: hidden; transition: background-color 0.3s ease; z-index: 1; border-left-width: 5px; }
        .runner-step-item.active { background-color: #e9f2ff; font-weight: 600; border-color: #4a90e2; }
        .runner-step-content { flex-grow: 1; text-align: left; padding: 12px 15px; position: relative; z-index: 2; }
        .runner-step-indicator { position: absolute; background-color: rgba(220, 53, 69, 0.4); z-index: 1; transition: height 1s linear, width 1s linear; }
        
        /* Vertical Layout */
        #runner-steps-list.vertical { max-height: 300px; overflow-y: auto; }
        .vertical .runner-step-item { margin-bottom: 8px; }
        .vertical .runner-step-indicator { left: 0; top: 0; width: 100%; height: 0; }
        
        /* Horizontal Layout */
        #runner-steps-list.horizontal { display: flex; overflow-x: auto; padding-bottom: 15px; }
        .horizontal .runner-step-item { flex: 0 0 180px; flex-direction: column; margin-right: 10px; text-align: center; }
        .horizontal .runner-step-content { text-align: center; width: 100%; }
        .horizontal .runner-step-indicator { left: 0; top: 0; width: 0; height: 100%; }

        .runner-step-content .name { color: #333; }
        .runner-step-content .details { font-size: 0.85em; color: #666; margin-top: 4px; }
        .runner-step-time-info.completed { color: #28a745; font-weight: bold; }
        .runner-cycle-info { font-weight: bold; color: #17a2b8; margin-left: 8px; }

        .hidden { display: none; }
        .button-group { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; }

    </style>
</head>
<body>

    <div class="app-container">
        <header>Protocol Runner</header>
        
        <main>
            <!-- Setup View -->
            <div id="setup-view">
                <div class="section">
                    <div class="section-title">Protocol Steps</div>
                    <ul id="protocol-steps"></ul>
                    <div style="text-align: center; margin-top: 20px;"><button id="add-step-btn" class="btn btn-icon" title="Add New Step">+</button></div>
                </div>
                <div class="section">
                    <div class="section-title">Protocol Information</div>
                    <p><strong>Total Time:</strong> <span id="total-time">00:00:00</span></p>
                </div>
                <div class="section">
                    <div class="section-title">Controls</div>
                    <div class="button-group">
                        <button id="start-btn" class="btn btn-success">Start Protocol</button>
                        <button id="save-protocol-btn" class="btn btn-primary">Save Protocol</button>
                        <button id="load-protocol-btn" class="btn btn-secondary">Load Protocol</button>
                        <input type="file" id="load-protocol-input" accept=".json" style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0;">
                        <button id="set-cycle-btn" class="btn btn-info">Set Cycle</button>
                    </div>
                </div>
            </div>

            <!-- Runner View -->
            <div id="runner-view" class="hidden">
                <div class="info-display">
                    <h3>Current Step: <span id="current-step-name"></span></h3>
                    <div id="step-countdown">00:00</div>
                    <p id="total-time-remaining-container"><strong>Total Time Remaining:</strong> <span id="total-time-remaining">00:00:00</span></p>
                    <p id="next-step-info">Next: <span></span></p>
                </div>
                <div>
                    <label>Current Step Progress</label>
                    <div class="progress-bar-container"><div id="step-progress-bar" class="progress-bar"></div></div>
                    <label>Overall Protocol Progress</label>
                    <div class="progress-bar-container"><div id="overall-progress-bar" class="progress-bar"></div></div>
                </div>
                <div id="runner-steps-list-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 10px;">
                        <h4 style="margin:0;">Protocol Flow</h4>
                        <button id="toggle-layout-btn" class="btn btn-info btn-sm">Toggle View</button>
                    </div>
                    <ul id="runner-steps-list" class="vertical"></ul>
                </div>
                <div class="button-group" style="margin-top: 20px;">
                    <button id="pause-btn" class="btn btn-warning">Pause</button>
                    <button id="resume-btn" class="btn btn-success hidden">Resume</button>
                    <button id="reset-btn" class="btn btn-danger">Reset Protocol</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Step Modal -->
    <div id="step-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title">Add Step</h2>
            <form id="step-form">
                <input type="hidden" id="step-id">
                <div class="form-group"><label for="step-name">Step Name</label><input type="text" id="step-name-input" required></div>
                <div class="form-group">
                    <label for="step-time">Time (MM:SS)</label>
                    <input type="text" id="step-time-input" required placeholder="MM:SS" pattern="[0-9]{1,2}:[0-5][0-9]">
                </div>
                <div class="form-group"><label for="step-parameter">Parameter (optional)</label><input type="text" id="step-parameter-input" placeholder="e.g., Temperature: 95°C"></div>
                <div class="form-group"><label for="step-description">Description (optional)</label><textarea id="step-description-input"></textarea></div>
                <div class="button-group" style="justify-content: flex-end;">
                    <button type="button" id="cancel-step-btn" class="btn btn-secondary">Cancel</button>
                    <button type="submit" id="save-step-btn" class="btn btn-primary">Save Step</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Cycle Modal -->
    <div id="cycle-modal" class="modal">
        <div class="modal-content">
            <h2>Configure Step Cycling</h2>
            <form id="cycle-form">
                <div class="form-group">
                    <label for="cycle-start-step">Start Step</label>
                    <select id="cycle-start-step" required></select>
                </div>
                <div class="form-group">
                    <label for="cycle-end-step">End Step</label>
                    <select id="cycle-end-step" required></select>
                </div>
                <div class="form-group">
                    <label for="cycle-count">Number of Repetitions</label>
                    <input type="number" id="cycle-count" min="2" value="2" required>
                </div>
                <div class="button-group" style="justify-content: flex-end;">
                    <button type="button" id="cancel-cycle-btn" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Cycle</button>
                </div>
            </form>
            <hr style="margin: 20px 0;">
            <h3>Existing Cycles</h3>
            <ul id="existing-cycles-list">
                <!-- Existing cycles will be listed here -->
            </ul>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const protocolStepsList = document.getElementById('protocol-steps');
            const addStepBtn = document.getElementById('add-step-btn');
            const stepModal = document.getElementById('step-modal');
            const stepForm = document.getElementById('step-form');
            const cancelStepBtn = document.getElementById('cancel-step-btn');
            const totalTimeEl = document.getElementById('total-time');
            const startBtn = document.getElementById('start-btn');
            const saveProtocolBtn = document.getElementById('save-protocol-btn');
            const loadProtocolBtn = document.getElementById('load-protocol-btn');
            const loadProtocolInput = document.getElementById('load-protocol-input');
            const setCycleBtn = document.getElementById('set-cycle-btn');
            const cycleModal = document.getElementById('cycle-modal');
            const cycleForm = document.getElementById('cycle-form');
            const cancelCycleBtn = document.getElementById('cancel-cycle-btn');
            const existingCyclesList = document.getElementById('existing-cycles-list');

            const setupView = document.getElementById('setup-view');
            const runnerView = document.getElementById('runner-view');
            const currentStepNameEl = document.getElementById('current-step-name');
            const stepCountdownEl = document.getElementById('step-countdown');
            const totalTimeRemainingEl = document.getElementById('total-time-remaining');
            const nextStepInfoEl = document.getElementById('next-step-info');
            const stepProgressBar = document.getElementById('step-progress-bar');
            const overallProgressBar = document.getElementById('overall-progress-bar');
            const runnerStepsList = document.getElementById('runner-steps-list');
            const toggleLayoutBtn = document.getElementById('toggle-layout-btn');
            const pauseBtn = document.getElementById('pause-btn');
            const resumeBtn = document.getElementById('resume-btn');
            const resetBtn = document.getElementById('reset-btn');

            // App State
            let protocolSteps = [];
            let protocolCycles = [];
            let editingStepId = null;
            let draggedItem = null;
            let isRunning = false;
            let isPaused = false;
            
            // Runner State
            let executionQueue = [];
            let executionQueueIndex = 0;
            let stepTimeRemaining = 0;
            let totalTimeElapsed = 0;
            let protocolInterval = null;

            // --- TIME FORMATTING & UTILITY HELPERS ---
            function secondsToMMSS(totalSeconds) {
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }

            function MMSSToSeconds(mmssString) {
                const parts = mmssString.split(':');
                if (parts.length !== 2) return 0;
                const minutes = parseInt(parts[0], 10) || 0;
                const seconds = parseInt(parts[1], 10) || 0;
                return (minutes * 60) + seconds;
            }

            function secondsToHHMMSS(totalSeconds) {
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                return [hours, minutes, seconds].map(v => String(v).padStart(2, '0')).join(':');
            }

            function getRandomColor() {
                const letters = '0123456789ABCDEF';
                let color = '#';
                for (let i = 0; i < 6; i++) {
                    color += letters[Math.floor(Math.random() * 16)];
                }
                return color;
            }

            // --- Sound Synthesis ---
            let audioCtx;
            function initAudio() {
                if (!audioCtx) {
                    try {
                        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    } catch (e) {
                        console.error("Web Audio API is not supported in this browser.");
                    }
                }
            }

            function playSound(type = 'step') {
                if (!audioCtx) return;
                const beepCount = type === 'step' ? 2 : 10;
                const freq = type === 'step' ? 880 : 1046.50;
                const duration = 0.1;
                const gap = 0.1;

                for (let i = 0; i < beepCount; i++) {
                    const startTime = audioCtx.currentTime + i * (duration + gap);
                    const oscillator = audioCtx.createOscillator();
                    const gainNode = audioCtx.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioCtx.destination);
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(freq, startTime);
                    gainNode.gain.setValueAtTime(0.5, startTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.00001, startTime + duration);
                    
                    oscillator.start(startTime);
                    oscillator.stop(startTime + duration);
                }
            }

            // --- UI Rendering ---
            function getVisualGroups() {
                const groups = [];
                const stepIdsInCycles = new Set();
                protocolCycles.forEach(c => {
                    const startIndex = protocolSteps.findIndex(s => s.id === c.startStepId);
                    const endIndex = protocolSteps.findIndex(s => s.id === c.endStepId);
                    if (startIndex > -1 && endIndex > -1) {
                        for (let i = startIndex; i <= endIndex; i++) stepIdsInCycles.add(protocolSteps[i].id);
                    }
                });

                protocolCycles.forEach(c => {
                    groups.push({
                        startId: c.startStepId,
                        endId: c.endStepId,
                        color: getRandomColor()
                    });
                });

                let currentGroup = null;
                protocolSteps.forEach(step => {
                    if (!stepIdsInCycles.has(step.id)) {
                        if (!currentGroup) {
                            currentGroup = {
                                startId: step.id,
                                endId: step.id,
                                color: getRandomColor()
                            };
                            groups.push(currentGroup);
                        } else {
                            currentGroup.endId = step.id;
                        }
                    } else {
                        currentGroup = null;
                    }
                });
                return groups;
            }

            function renderSteps() {
                protocolStepsList.innerHTML = '';
                const visualGroups = getVisualGroups();

                if (protocolSteps.length === 0) {
                    protocolStepsList.innerHTML = '<p style="text-align:center; color:#999;">No steps yet. Click the + button to add one.</p>';
                } else {
                    protocolSteps.forEach((step, index) => {
                        const li = document.createElement('li');
                        li.className = 'step-item';
                        
                        const group = visualGroups.find(g => {
                            const startIndex = protocolSteps.findIndex(s => s.id === g.startId);
                            const endIndex = protocolSteps.findIndex(s => s.id === g.endId);
                            return index >= startIndex && index <= endIndex;
                        });
                        if (group) {
                            li.style.borderLeft = `5px solid ${group.color}`;
                        }

                        li.setAttribute('draggable', 'true');
                        li.dataset.id = step.id;
                        li.innerHTML = `
                            <span class="drag-handle">☰</span>
                            <div class="step-content">
                                <div class="step-name">${step.name}</div>
                                <div class="step-details">
                                    <span><strong>Time:</strong> ${secondsToMMSS(step.time)}</span>
                                    ${step.parameter ? `<span><strong>Param:</strong> ${step.parameter}</span>` : ''}
                                </div>
                                ${step.description ? `<div class="step-description">${step.description}</div>` : ''}
                            </div>
                            <div class="step-actions">
                                <button class="edit-step-btn" title="Edit Step">✏️</button>
                                <button class="delete-step-btn" title="Delete Step">🗑️</button>
                            </div>
                        `;
                        protocolStepsList.appendChild(li);
                    });
                }
                updateTotalTime();
                addStepEventListeners();
            }

            function renderRunnerSteps() {
                runnerStepsList.innerHTML = '';
                const visualGroups = getVisualGroups();

                executionQueue.forEach((execStep, index) => {
                    const li = document.createElement('li');
                    li.className = 'runner-step-item';
                    li.dataset.execIndex = index;

                    const group = visualGroups.find(g => {
                        const stepIndex = protocolSteps.findIndex(s => s.id === execStep.id);
                        const startIndex = protocolSteps.findIndex(s => s.id === g.startId);
                        const endIndex = protocolSteps.findIndex(s => s.id === g.endId);
                        return stepIndex >= startIndex && stepIndex <= endIndex;
                    });
                    if (group) {
                        li.style.borderLeftColor = group.color;
                    }

                    li.innerHTML = `
                        <div class="runner-step-indicator"></div>
                        <div class="runner-step-content">
                            <div class="name">${execStep.name} ${execStep.cycleInfo ? `<span class="runner-cycle-info">(${execStep.cycleInfo})</span>` : ''}</div>
                            <div class="details">
                                <span class="runner-step-time-info">Time: ${secondsToMMSS(execStep.time)}</span>
                                ${execStep.parameter ? `<span> | ${execStep.parameter}</span>` : ''}
                            </div>
                        </div>`;
                    runnerStepsList.appendChild(li);
                });
            }

            function updateTotalTime() {
                const flattenedForTime = buildExecutionQueue();
                const totalSeconds = flattenedForTime.reduce((sum, step) => sum + step.time, 0);
                totalTimeEl.textContent = secondsToHHMMSS(totalSeconds);
            }

            // --- Modal Logic ---
            function openModal(type, id = null) {
                if (type === 'step') {
                    stepForm.reset();
                    editingStepId = id;
                    const modalTitle = document.getElementById('modal-title');
                    const timeInput = document.getElementById('step-time-input');

                    if (id) {
                        modalTitle.textContent = 'Edit Step';
                        const step = protocolSteps.find(s => s.id === id);
                        if (step) {
                            document.getElementById('step-id').value = step.id;
                            document.getElementById('step-name-input').value = step.name;
                            timeInput.value = secondsToMMSS(step.time);
                            document.getElementById('step-parameter-input').value = step.parameter;
                            document.getElementById('step-description-input').value = step.description;
                        }
                    } else {
                        modalTitle.textContent = 'Add Step';
                    }
                    stepModal.style.display = 'flex';
                } else if (type === 'cycle') {
                    populateCycleModal();
                    cycleModal.style.display = 'flex';
                }
            }

            function closeModal(type) {
                if (type === 'step') stepModal.style.display = 'none';
                if (type === 'cycle') cycleModal.style.display = 'none';
            }

            // --- Step Management ---
            function handleFormSubmit(e) {
                e.preventDefault();
                const timeInput = document.getElementById('step-time-input').value;
                if (!/^[0-9]{1,2}:[0-5][0-9]$/.test(timeInput)) {
                    alert('Please enter the time in MM:SS format.');
                    return;
                }

                const stepData = {
                    id: editingStepId || (Date.now() + Math.random()),
                    name: document.getElementById('step-name-input').value,
                    time: MMSSToSeconds(timeInput),
                    parameter: document.getElementById('step-parameter-input').value,
                    description: document.getElementById('step-description-input').value,
                };
                if (editingStepId) {
                    protocolSteps = protocolSteps.map(step => step.id === editingStepId ? stepData : step);
                } else {
                    protocolSteps.push(stepData);
                }
                renderSteps();
                closeModal('step');
            }

            function deleteStep(stepId) {
                if (confirm('Are you sure you want to delete this step? This will also remove any cycles it is part of.')) {
                    protocolSteps = protocolSteps.filter(step => step.id !== stepId);
                    protocolCycles = protocolCycles.filter(c => c.startStepId !== stepId && c.endStepId !== stepId);
                    renderSteps();
                }
            }

            // --- Cycle Management ---
            function populateCycleModal() {
                const startSelect = document.getElementById('cycle-start-step');
                const endSelect = document.getElementById('cycle-end-step');
                startSelect.innerHTML = '';
                endSelect.innerHTML = '';

                protocolSteps.forEach(step => {
                    const option = `<option value="${step.id}">${step.name}</option>`;
                    startSelect.innerHTML += option;
                    endSelect.innerHTML += option;
                });
                renderExistingCycles();
            }

            function handleCycleFormSubmit(e) {
                e.preventDefault();
                const startStepId = parseFloat(document.getElementById('cycle-start-step').value);
                const endStepId = parseFloat(document.getElementById('cycle-end-step').value);
                const count = parseInt(document.getElementById('cycle-count').value, 10);

                const startIndex = protocolSteps.findIndex(s => s.id === startStepId);
                const endIndex = protocolSteps.findIndex(s => s.id === endStepId);

                if (startIndex > endIndex) {
                    alert('Start step must come before or be the same as the end step.');
                    return;
                }

                protocolCycles.push({ id: Date.now(), startStepId, endStepId, count });
                renderSteps();
                renderExistingCycles();
                updateTotalTime();
            }
            
            function renderExistingCycles() {
                existingCyclesList.innerHTML = '';
                protocolCycles.forEach((cycle, index) => {
                    const startStep = protocolSteps.find(s => s.id === cycle.startStepId);
                    const endStep = protocolSteps.find(s => s.id === cycle.endStepId);
                    if (!startStep || !endStep) return;

                    const li = document.createElement('li');
                    li.className = 'existing-cycle-item';
                    li.innerHTML = `
                        <span>G${index + 1}: Repeat ${startStep.name} → ${endStep.name} (${cycle.count} times)</span>
                        <button data-cycle-id="${cycle.id}">Delete</button>
                    `;
                    existingCyclesList.appendChild(li);
                });

                existingCyclesList.querySelectorAll('button').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const cycleId = parseFloat(e.target.dataset.cycleId);
                        protocolCycles = protocolCycles.filter(c => c.id !== cycleId);
                        renderSteps();
                        renderExistingCycles();
                        updateTotalTime();
                    });
                });
            }


            // --- Drag and Drop ---
            function handleDragStart(e) {
                draggedItem = e.target;
                setTimeout(() => e.target.classList.add('dragging'), 0);
            }
            function handleDragEnd(e) { e.target.classList.remove('dragging'); }
            function handleDragOver(e) {
                e.preventDefault();
                const afterElement = getDragAfterElement(protocolStepsList, e.clientY);
                const dragging = document.querySelector('.dragging');
                if (afterElement == null) {
                    protocolStepsList.appendChild(dragging);
                } else {
                    protocolStepsList.insertBefore(dragging, afterElement);
                }
            }
            function handleDrop() {
                const newOrderIds = [...protocolStepsList.querySelectorAll('.step-item')].map(item => parseFloat(item.dataset.id));
                protocolSteps.sort((a, b) => newOrderIds.indexOf(a.id) - newOrderIds.indexOf(b.id));
                renderSteps();
            }
            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.step-item:not(.dragging)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            // --- Protocol Runner Logic ---
            function buildExecutionQueue() {
                const queue = [];
                let i = 0;
                while (i < protocolSteps.length) {
                    const currentStep = protocolSteps[i];
                    const cycle = protocolCycles.find(c => c.startStepId === currentStep.id);
                    const cycleGroupIndex = protocolCycles.findIndex(c => c.id === (cycle ? cycle.id : -1));

                    if (cycle) {
                        const startIndex = i;
                        const endIndex = protocolSteps.findIndex(s => s.id === cycle.endStepId);
                        if (endIndex === -1) { // Cycle end step was deleted
                            queue.push({ ...currentStep });
                            i++;
                            continue;
                        }
                        
                        const cycleSteps = protocolSteps.slice(startIndex, endIndex + 1);
                        for (let j = 0; j < cycle.count; j++) {
                            cycleSteps.forEach(stepInCycle => {
                                queue.push({
                                    ...stepInCycle,
                                    cycleInfo: `G${cycleGroupIndex + 1} ${j + 1}/${cycle.count}`
                                });
                            });
                        }
                        i = endIndex + 1;
                    } else {
                        queue.push({ ...currentStep });
                        i++;
                    }
                }
                return queue;
            }

            function startProtocol() {
                executionQueue = buildExecutionQueue();
                if (executionQueue.length === 0) {
                    alert('Please add at least one step to the protocol.');
                    return;
                }
                initAudio();
                isRunning = true;
                isPaused = false;
                executionQueueIndex = 0;
                totalTimeElapsed = 0;

                setupView.classList.add('hidden');
                runnerView.classList.remove('hidden');
                pauseBtn.classList.remove('hidden');
                resumeBtn.classList.add('hidden');
                
                renderRunnerSteps();
                loadStep(0);
                protocolInterval = setInterval(tick, 1000);
            }
            
            function loadStep(index) {
                executionQueueIndex = index;
                const step = executionQueue[executionQueueIndex];
                stepTimeRemaining = step.time;
                updateRunnerUI(); 
            }
            
            function advanceStep() {
                const nextIndex = executionQueueIndex + 1;
                if (nextIndex >= executionQueue.length) {
                    completeProtocol();
                } else {
                    loadStep(nextIndex);
                }
            }

            function tick() {
                if (isPaused) return;
                
                updateRunnerUI(); 

                if (stepTimeRemaining <= 0) {
                    playSound('step');
                    advanceStep();
                } else {
                    stepTimeRemaining--;
                    totalTimeElapsed++;
                }
            }
            
            function updateRunnerUI() {
                const currentStep = executionQueue[executionQueueIndex];
                if (!currentStep) return;

                const totalProtocolTime = executionQueue.reduce((sum, step) => sum + step.time, 0);
                
                const timeRemaining = totalProtocolTime - totalTimeElapsed;
                stepCountdownEl.textContent = secondsToMMSS(stepTimeRemaining < 0 ? 0 : stepTimeRemaining);
                totalTimeRemainingEl.textContent = secondsToHHMMSS(timeRemaining < 0 ? 0 : timeRemaining);

                const stepProgressVal = ((currentStep.time - stepTimeRemaining) / currentStep.time) * 100;
                stepProgressBar.style.width = `${Math.min(100, stepProgressVal)}%`;
                const overallProgressVal = (totalTimeElapsed / totalProtocolTime) * 100;
                overallProgressBar.style.width = `${Math.min(100, overallProgressVal)}%`;

                // Update runner list visuals
                const runnerItems = runnerStepsList.querySelectorAll('.runner-step-item');
                runnerItems.forEach((item, itemIndex) => {
                    item.classList.remove('active');
                    const indicator = item.querySelector('.runner-step-indicator');
                    const prop = runnerStepsList.classList.contains('horizontal') ? 'width' : 'height';
                    
                    if (itemIndex < executionQueueIndex) {
                         indicator.style[prop] = '100%';
                    } else if (itemIndex > executionQueueIndex) {
                        indicator.style[prop] = '0%';
                    }

                    if (itemIndex === executionQueueIndex) {
                        item.classList.add('active');
                        item.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                        indicator.style[prop] = `${Math.min(100, stepProgressVal)}%`;
                        
                        const timeInfo = item.querySelector('.runner-step-time-info');
                        if (timeInfo) {
                            timeInfo.textContent = `${secondsToMMSS(stepTimeRemaining < 0 ? 0 : stepTimeRemaining)} / ${secondsToMMSS(currentStep.time)}`;
                        }
                    }
                });

                currentStepNameEl.innerHTML = `${currentStep.name} <span class="runner-cycle-info">${currentStep.cycleInfo || ''}</span>`;

                const nextStep = executionQueue[executionQueueIndex + 1];
                nextStepInfoEl.innerHTML = nextStep ? `Next: <span>${nextStep.name} ${nextStep.cycleInfo || ''}</span>` : 'Last step!';
            }
            
            function pauseProtocol() {
                isPaused = true;
                pauseBtn.classList.add('hidden');
                resumeBtn.classList.remove('hidden');
                clearInterval(protocolInterval);
            }
            
            function resumeProtocol() {
                isPaused = false;
                pauseBtn.classList.remove('hidden');
                resumeBtn.classList.add('hidden');
                protocolInterval = setInterval(tick, 1000);
            }
            
            function resetProtocol(isConfirm = true) {
                const doReset = isConfirm ? confirm('Are you sure you want to reset the protocol?') : true;
                if (doReset) {
                    clearInterval(protocolInterval);
                    isRunning = false;
                    isPaused = false;
                    setupView.classList.remove('hidden');
                    runnerView.classList.add('hidden');
                    runnerStepsList.innerHTML = '';
                }
            }
            
            function completeProtocol() {
                clearInterval(protocolInterval);
                const totalProtocolTime = executionQueue.reduce((sum, step) => sum + step.time, 0);
                totalTimeElapsed = totalProtocolTime;
                stepTimeRemaining = 0;
                updateRunnerUI();

                playSound('complete');
                runnerStepsList.querySelector('.active')?.classList.remove('active');
                alert('Protocol completed!');
                resetProtocol(false);
            }

            // --- Save/Load Protocol ---
            function saveProtocol() {
                if (protocolSteps.length === 0) {
                    alert('Nothing to save.');
                    return;
                }
                const protocolData = {
                    steps: protocolSteps,
                    cycles: protocolCycles
                };
                const dataStr = JSON.stringify(protocolData, null, 2);
                const link = document.createElement('a');
                link.href = URL.createObjectURL(new Blob([dataStr], {type: 'application/json'}));
                link.download = `protocol_${Date.now()}.json`;
                link.click();
                URL.revokeObjectURL(link.href);
            }
            
            function handleFileLoad(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const loadedData = JSON.parse(e.target.result);
                        if (loadedData.steps && Array.isArray(loadedData.steps)) {
                            protocolSteps = loadedData.steps;
                            protocolCycles = (loadedData.cycles && Array.isArray(loadedData.cycles)) ? loadedData.cycles : [];
                            renderSteps();
                        } else if (Array.isArray(loadedData)) { 
                            protocolSteps = loadedData;
                            protocolCycles = [];
                            renderSteps();
                        } else {
                            alert('Invalid protocol file format.');
                        }
                    } catch (error) {
                        console.error("Error parsing protocol file:", error);
                        alert('Error reading or parsing the protocol file.');
                    }
                    loadProtocolInput.value = '';
                };
                reader.readAsText(file);
            }

            // --- Event Listeners ---
            function addStepEventListeners() {
                document.querySelectorAll('.edit-step-btn').forEach(btn => btn.addEventListener('click', (e) => openModal('step', parseFloat(e.target.closest('.step-item').dataset.id))));
                document.querySelectorAll('.delete-step-btn').forEach(btn => btn.addEventListener('click', (e) => deleteStep(parseFloat(e.target.closest('.step-item').dataset.id))));
                document.querySelectorAll('.step-item').forEach(item => {
                    item.addEventListener('dragstart', handleDragStart);
                    item.addEventListener('dragend', handleDragEnd);
                });
            }

            addStepBtn.addEventListener('click', () => openModal('step'));
            cancelStepBtn.addEventListener('click', () => closeModal('step'));
            stepModal.addEventListener('click', (e) => e.target === stepModal && closeModal('step'));
            stepForm.addEventListener('submit', handleFormSubmit);
            
            setCycleBtn.addEventListener('click', () => openModal('cycle'));
            cancelCycleBtn.addEventListener('click', () => closeModal('cycle'));
            cycleModal.addEventListener('click', (e) => e.target === cycleModal && closeModal('cycle'));
            cycleForm.addEventListener('submit', handleCycleFormSubmit);

            protocolStepsList.addEventListener('dragover', handleDragOver);
            protocolStepsList.addEventListener('drop', handleDrop);
            startBtn.addEventListener('click', startProtocol);
            pauseBtn.addEventListener('click', pauseProtocol);
            resumeBtn.addEventListener('click', resumeProtocol);
            resetBtn.addEventListener('click', () => resetProtocol(true));
            saveProtocolBtn.addEventListener('click', saveProtocol);
            loadProtocolBtn.addEventListener('click', () => loadProtocolInput.click());
            loadProtocolInput.addEventListener('change', handleFileLoad);
            toggleLayoutBtn.addEventListener('click', () => {
                runnerStepsList.classList.toggle('horizontal');
                runnerStepsList.classList.toggle('vertical');
            });

            // Initial Render
            renderSteps();
        });
    </script>
</body>
</html>

